
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CCD AUC Table Navigator ‚Äî Chest Pain Test (PDF Jump + Voice + Copy&Open)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{
      --bg:#f3f4f6;
      --panel:#ffffff;
      --ink:#111827;
      --muted:#6b7280;
      --border:#d1d5db;
      --accent:#2563eb;
      --accent-strong:#1d4ed8;
      --soft:#eff6ff;
      --warn:#b45309;
      --warnbg:#fffbeb;
      --ok:#16a34a;
      --okbg:#ecfdf5;
      --radius:16px;
      --radius2:12px;
      --shadow:0 10px 25px rgba(15,23,42,.12);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: radial-gradient(circle at top left, #e0f2fe 0, var(--bg) 45%, #e5e7eb 100%);
      color:var(--ink);
      padding:14px;
      min-height:100vh;
    }
    .wrap{max-width:1320px;margin:0 auto}
    header{
      background: linear-gradient(135deg,#fff,#e0f2fe);
      border:1px solid rgba(148,163,184,.35);
      border-radius: 18px;
      box-shadow: 0 16px 40px rgba(15,23,42,.15);
      padding:14px 16px;
      position:sticky;
      top:8px;
      z-index:10;
      backdrop-filter: blur(10px);
    }
    .top{display:flex;gap:12px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap}
    .title{
      font-weight:900;
      letter-spacing:.04em;
      text-transform:uppercase;
      color:var(--accent-strong);
      font-size:1.05rem;
    }
    .sub{
      margin-top:6px;
      color:var(--muted);
      font-size:.92rem;
      line-height:1.35;
      max-width:1060px;
    }
    .badge{
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 10px;border-radius:999px;
      border:1px solid rgba(37,99,235,.18);
      background: rgba(37,99,235,.06);
      color:var(--accent-strong);
      font-size:.75rem;
      font-weight:800;
      text-transform:uppercase;
      letter-spacing:.08em;
      white-space:nowrap;
    }
    .dot{
      width:8px;height:8px;border-radius:999px;background:#22c55e;
      box-shadow:0 0 0 4px rgba(34,197,94,.25);
    }

    /* Give the PDF MORE space (width) */
    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: minmax(340px, 0.62fr) minmax(0, 1.38fr);
      gap:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      header{position:static}
    }
    .panel{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:12px;
      min-height:0;
    }
    .ph{display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;margin-bottom:10px}
    .pt{display:flex;align-items:center;gap:8px;font-weight:900;font-size:.95rem}
    .step{
      width:26px;height:26px;border-radius:999px;
      display:flex;align-items:center;justify-content:center;
      background:var(--accent);color:#fff;font-weight:900;font-size:.85rem;
      flex-shrink:0;
    }
    .note{color:var(--muted);font-size:.78rem;line-height:1.35}
    fieldset{
      border:1px solid var(--border);
      background:#f9fafb;
      border-radius: var(--radius2);
      padding:10px;
      margin-top:10px;
    }
    legend{
      padding:0 6px;
      color:var(--muted);
      font-weight:900;
      font-size:.74rem;
      letter-spacing:.08em;
      text-transform:uppercase;
    }
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .choice{
      flex:1;min-width:190px;
      border:1px solid var(--border);
      border-radius: 12px;
      background:#fff;
      padding:10px;
      cursor:pointer;
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
      user-select:none;
    }
    .choice:hover{transform: translateY(-1px); box-shadow:0 8px 18px rgba(15,23,42,.12)}
    .choice.active{border-color: rgba(37,99,235,.85); box-shadow:0 0 0 3px rgba(37,99,235,.18)}
    .choice .lbl{font-weight:900;font-size:.9rem}
    .choice .sm{color:var(--muted);font-size:.8rem;margin-top:4px;line-height:1.25}

    .btnrow{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    button{
      border:none;border-radius:12px;
      padding:10px 12px;
      font-weight:900;
      font-size:.82rem;
      cursor:pointer;
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease;
      min-width: 168px;
    }
    .primary{background:var(--accent);color:#fff}
    .primary:hover{background:var(--accent-strong);transform:translateY(-1px);box-shadow:0 10px 22px rgba(37,99,235,.28)}
    .secondary{background:#e5e7eb;color:var(--ink)}
    .secondary:hover{background:#d1d5db;transform:translateY(-1px);box-shadow:0 8px 18px rgba(15,23,42,.12)}

    .pill{
      border-radius: 999px;
      padding:6px 10px;
      background:#eff6ff;
      border:1px solid #bfdbfe;
      font-size:.78rem;
      font-weight:900;
      color:#1e40af;
      display:inline-flex;gap:6px;align-items:center;
    }

    .callout{
      border-radius:12px;
      padding:10px;
      border:1px solid var(--border);
      margin-top:10px;
      line-height:1.35;
      font-size:.86rem;
    }
    .warn{background:var(--warnbg);border-color:#fcd34d}
    .ok{background:var(--okbg);border-color:#86efac}
    .callout strong{font-weight:900}
    .mono{font-family:var(--mono)}
    .small{font-size:.78rem;color:var(--muted);margin-top:8px;line-height:1.35}
    .kbd{font-family:var(--mono);background:#111827;color:#fff;padding:1px 6px;border-radius:6px;font-size:.75rem;font-weight:900}

    .checks{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px;margin-top:8px}
    @media (max-width: 520px){.checks{grid-template-columns:1fr}}
    .check{
      display:flex;gap:8px;align-items:flex-start;
      padding:8px;border-radius:12px;border:1px solid #bfdbfe;background:#eff6ff;
      font-size:.84rem;font-weight:900;
    }
    .check input{accent-color:var(--accent);margin-top:2px;flex-shrink:0}

    .outbox{
      background:#0f172a;color:#e2e8f0;border-radius:12px;
      padding:10px;
      font-family:var(--mono);
      font-size:.82rem;
      line-height:1.5;
      white-space:pre-wrap;
      max-height: 320px;
      overflow:auto;
      border:1px solid rgba(148,163,184,.3);
    }

    .toast{
      position:fixed;
      bottom:18px;right:18px;
      background:#111827;color:#fff;
      padding:10px 14px;
      border-radius:12px;
      box-shadow:0 14px 34px rgba(0,0,0,.35);
      z-index:9999;
      font-weight:900;
      max-width: min(560px, 92vw);
      animation: slidein .22s ease;
    }
    @keyframes slidein{
      from{transform:translateX(320px);opacity:0}
      to{transform:translateX(0);opacity:1}
    }

    .mini-toggle{
      display:flex;gap:8px;align-items:center;
      padding:8px;border-radius:12px;border:1px solid #bfdbfe;background:#eff6ff;
      font-size:.84rem;font-weight:900;
      margin-top:10px;
    }
    .mini-toggle input{accent-color:var(--accent)}
    .ai-links{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
    }
    .ai-links button{min-width: 210px}

    /* PDF.js viewer area - make it TALLER */
    .pdfwrap{
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:0;
    }
    .pdfTop{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;
    }
    input[type="text"]{
      width:100%;
      padding:9px 10px;
      border:1px solid var(--border);
      border-radius:12px;
      font-family:var(--mono);
      font-size:.82rem;
      outline:none;
    }
    input[type="text"]:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(37,99,235,.18)}

    .pdfwrap .btnrow{margin-top:0}
    .pdfScroll{
      width:100%;
      height: calc(100vh - 230px); /* bigger/longer */
      border:1px solid var(--border);
      border-radius: 14px;
      background:#fff;
      overflow:auto;
      padding: 10px;
    }
    @media (max-width: 980px){
      .pdfScroll{height: calc(100vh - 260px)}
    }
    .pageCard{
      border:1px solid rgba(148,163,184,.35);
      border-radius:14px;
      padding:10px;
      margin-bottom: 12px;
      box-shadow: 0 10px 22px rgba(15,23,42,.10);
      background: linear-gradient(180deg, #ffffff, #f8fafc);
    }
    .pageHdr{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom: 8px;
    }
    .pageNum{
      font-weight:900;
      color: var(--accent-strong);
      letter-spacing:.02em;
    }
    .canvasWrap{
      width: 100%;
      display:flex;
      justify-content:center;
    }
    canvas{
      max-width: 100%;
      height: auto;
      border-radius: 10px;
      background: #fff;
    }
    .loading{
      padding:12px;
      border-radius:12px;
      border:1px solid #bfdbfe;
      background:#eff6ff;
      font-weight:900;
      color:#1e40af;
    }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="top">
      <div>
        <div class="title">CCD AUC Table Navigator ‚Äî Chest Pain Test</div>
        <div class="sub">
          Use the flowchart logic to jump to the right AUC table pages (<span class="mono">p12‚Äìp14</span>) inside <span class="mono">chestpaintest.pdf</span>.
          <strong>This is NOT medical advice.</strong> It only helps you find the relevant tables quickly.
          AI summaries can be wrong ‚Äî verify by reading the PDF tables & footnotes.
        </div>
      </div>
      <div class="badge"><span class="dot"></span> Prototype</div>
    </div>
  </header>

  <div class="grid">

    <!-- LEFT: CALCULATOR + AI PAYLOAD -->
    <section class="panel">
      <div class="ph">
        <div class="pt"><span class="step">1</span> Calculator (Flowchart ‚Üí Table)</div>
        <div class="note">Pick symptoms ‚Üí pick scenario ‚Üí jump (scroll) to the right PDF page.</div>
      </div>

      <div class="callout warn">
        <strong>Reminder:</strong> Not medical advice. This tool navigates the PDF; you must read the tables & footnotes yourself.
        AI can make mistakes ‚Äî verify.
      </div>

      <fieldset>
        <legend>Symptoms of ischemia?</legend>
        <div class="row" id="symptomRow">
          <div class="choice" data-sym="yes" tabindex="0" role="button" aria-label="Symptoms: Yes">
            <div class="lbl">Yes</div>
            <div class="sm">Symptomatic / ischemic symptoms are present</div>
          </div>
          <div class="choice" data-sym="no" tabindex="0" role="button" aria-label="Symptoms: No">
            <div class="lbl">No</div>
            <div class="sm">No symptoms of ischemia</div>
          </div>
        </div>
      </fieldset>

      <fieldset>
        <legend>Which clinical scenario?</legend>
        <div class="note">Options depend on your answer above.</div>
        <div class="row" id="scenarioRow" style="margin-top:10px;"></div>

        <div class="callout ok" id="resultBox" style="display:none;">
          <strong>Result:</strong>
          <div style="margin-top:6px;">
            <span class="mono" id="resultLine">‚Äî</span>
          </div>
          <div class="small">
            Page mapping:
            <span class="mono">p12</span> (Tables 1.1‚Äì1.2),
            <span class="mono">p13</span> (Tables 1.3‚Äì2.2),
            <span class="mono">p14</span> (Tables 2.3‚Äì2.4).
          </div>
        </div>

        <div class="btnrow">
          <button class="primary" id="jumpBtn">üìÑ Jump (scroll) to page</button>
          <button class="secondary" id="openPdfNewTabBtn">‚Üó Open PDF at page</button>
        </div>

        <div class="small">
          After jumping, scroll within the PDF panel. You can also use <span class="kbd">Ctrl+F</span> / <span class="kbd">‚åò+F</span>
          and search for <span class="mono">Table 1.1</span>, etc.
        </div>
      </fieldset>

      <div class="mini-toggle">
        <input type="checkbox" id="voiceToggle" checked />
        <label for="voiceToggle">Voice guide (speaks step-by-step instructions)</label>
      </div>

      <div class="ph" style="margin-top:12px;">
        <div class="pt"><span class="step">2</span> AI Summary Prompt</div>
        <div class="note">Copy + open Copilot (or other models). Voice will guide paste steps.</div>
      </div>

      <fieldset>
        <legend>Emphasis (checkboxes)</legend>
        <div class="checks">
          <label class="check"><input type="checkbox" class="emph" value="radiation exposure / dose considerations" checked />Radiation</label>
          <label class="check"><input type="checkbox" class="emph" value="contrast / renal function and contraindications" checked />Contrast / renal</label>
          <label class="check"><input type="checkbox" class="emph" value="exercise capacity / ECG interpretability / stress modality fit" />Exercise fit</label>
          <label class="check"><input type="checkbox" class="emph" value="test availability, timeliness, and operational feasibility" />Feasibility</label>
          <label class="check"><input type="checkbox" class="emph" value="downstream testing implications / false positives / incidental findings" />Downstream impact</label>
          <label class="check"><input type="checkbox" class="emph" value="what decision the test changes (management impact)" checked />Decision impact</label>
        </div>
      </fieldset>

      <fieldset>
        <legend>Prompt (copy/paste)</legend>
        <div class="note">The prompt instructs the AI to only summarize what it can directly read from the PDF and to quote table rows/footnotes.</div>
        <div class="outbox" id="promptBox">Select a scenario to generate a prompt‚Ä¶</div>

        <div class="ai-links">
          <button class="primary" id="copilotBtn">üìã Copy + Open Copilot (M365)</button>
          <button class="secondary" id="chatgptBtn">üìã Copy + Open ChatGPT</button>
          <button class="secondary" id="claudeBtn">üìã Copy + Open Claude</button>
          <button class="secondary" id="geminiBtn">üìã Copy + Open Gemini</button>
        </div>

        <div class="small">
          Source PDF (publisher): <span class="mono">https://www.jacc.org/doi/epdf/10.1016/j.jacc.2023.03.410</span><br>
          Local PDF on this site: <span class="mono" id="sitePdfUrl">(computed)</span>
        </div>
      </fieldset>

      <div class="callout warn">
        <strong>Not medical advice.</strong> The AI prompt tells the model to cite/quote from the PDF and to stop if it can‚Äôt access the table.
        Still verify the original tables and footnotes.
      </div>
    </section>

    <!-- RIGHT: PDF VIEWER (PDF.js, reliable jump) -->
    <section class="panel pdfwrap">
      <div class="ph">
        <div class="pt"><span class="step">3</span> PDF Viewer (reliable jump)</div>
        <div class="note">Rendered with PDF.js so ‚Äújump‚Äù works on GitHub Pages.</div>
      </div>

      <div class="pdfTop">
        <div class="pill">Default render range: <span class="mono">pages 8‚Äì14</span> (tables A/B/C + 1.1‚Äì2.4)</div>
        <div class="btnrow">
          <button class="secondary" id="renderTablesBtn">Render pages 8‚Äì14</button>
          <button class="secondary" id="renderAllBtn">Render ALL pages</button>
        </div>
      </div>

      <div class="note">
        PDF path (default is <span class="mono">./chestpaintest.pdf</span>). If you change it, re-render.
      </div>
      <input id="pdfPath" type="text" spellcheck="false" />

      <div class="pdfScroll" id="pdfScroll">
        <div class="loading">Loading PDF viewer‚Ä¶</div>
      </div>

      <div class="small">
        If rendering fails, check the PDF path and ensure the file exists in your repo.
        You can also open the PDF directly at: <span class="mono" id="directPdfLink">(computed)</span>
      </div>
    </section>

  </div>
</div>

<script type="module">
  import * as pdfjsLib from "https://unpkg.com/pdfjs-dist@5.4.624/build/pdf.min.mjs";
  pdfjsLib.GlobalWorkerOptions.workerSrc = "https://unpkg.com/pdfjs-dist@5.4.624/build/pdf.worker.min.mjs";

  const LOCAL_PDF_DEFAULT = "./chestpaintest.pdf";
  const JACC_PDF = "https://www.jacc.org/doi/epdf/10.1016/j.jacc.2023.03.410";

  const COPILOT_URL = "https://m365.cloud.microsoft/chat/?fromCode=cmcv2&redirectId=ACB3DED96EE440709FB6B42BE2DCA492&internalredirect=CCM&auth=2";
  const CHATGPT_URL = "https://chat.openai.com/";
  const CLAUDE_URL  = "https://claude.ai/";
  const GEMINI_URL  = "https://gemini.google.com/";

  const TABLES = {
    "1.1": { label: "Table 1.1", page: 12, scenario: "Symptoms of ischemia: YES ‚Üí No prior testing" },
    "1.2": { label: "Table 1.2", page: 12, scenario: "Symptoms of ischemia: YES ‚Üí Prior testing without MI or revascularization" },
    "1.3": { label: "Table 1.3", page: 13, scenario: "Symptoms of ischemia: YES ‚Üí Prior MI or revascularization" },
    "2.1": { label: "Table 2.1", page: 13, scenario: "Symptoms of ischemia: NO ‚Üí Testing for risk of ASCVD events" },
    "2.2": { label: "Table 2.2", page: 13, scenario: "Symptoms of ischemia: NO ‚Üí Prior MI or revascularization (e.g., rehabilitation)" },
    "2.3": { label: "Table 2.3", page: 14, scenario: "Symptoms of ischemia: NO ‚Üí Exercise Rx / rehabilitation" },
    "2.4": { label: "Table 2.4", page: 14, scenario: "Symptoms of ischemia: NO ‚Üí Other CV conditions (e.g., heart failure, arrhythmia, syncope)" }
  };

  const SCENARIOS_BY_SYM = {
    yes: [
      { key: "1.1", title: "No prior testing", sub: "Go to Table 1.1 (page 12)" },
      { key: "1.2", title: "Prior testing w/o MI or revascularization", sub: "Go to Table 1.2 (page 12)" },
      { key: "1.3", title: "Prior MI or revascularization", sub: "Go to Table 1.3 (page 13)" }
    ],
    no: [
      { key: "2.1", title: "Testing for risk of ASCVD events", sub: "Go to Table 2.1 (page 13)" },
      { key: "2.2", title: "Prior MI or revasc (e.g., rehab)", sub: "Go to Table 2.2 (page 13)" },
      { key: "2.3", title: "Exercise Rx / Rehab", sub: "Go to Table 2.3 (page 14)" },
      { key: "2.4", title: "Other CV conditions*", sub: "Go to Table 2.4 (page 14)" }
    ]
  };

  const symptomRow = document.getElementById('symptomRow');
  const scenarioRow = document.getElementById('scenarioRow');
  const resultBox = document.getElementById('resultBox');
  const resultLine = document.getElementById('resultLine');
  const jumpBtn = document.getElementById('jumpBtn');
  const openPdfNewTabBtn = document.getElementById('openPdfNewTabBtn');

  const voiceToggle = document.getElementById('voiceToggle');

  const promptBox = document.getElementById('promptBox');
  const copilotBtn = document.getElementById('copilotBtn');
  const chatgptBtn = document.getElementById('chatgptBtn');
  const claudeBtn  = document.getElementById('claudeBtn');
  const geminiBtn  = document.getElementById('geminiBtn');

  const pdfPathEl = document.getElementById('pdfPath');
  const pdfScroll = document.getElementById('pdfScroll');
  const renderTablesBtn = document.getElementById('renderTablesBtn');
  const renderAllBtn = document.getElementById('renderAllBtn');

  const sitePdfUrlEl = document.getElementById('sitePdfUrl');
  const directPdfLinkEl = document.getElementById('directPdfLink');

  let selectedSym = null;
  let selectedTableKey = null;

  let pdfDoc = null;
  let renderedPages = new Set();

  function toast(msg, ms=2600){
    const t = document.createElement('div');
    t.className = 'toast';
    t.textContent = msg;
    document.body.appendChild(t);
    setTimeout(()=>t.remove(), ms);
  }

  function speak(text){
    if (!voiceToggle.checked) return;
    if (!('speechSynthesis' in window)) return;
    try{
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.rate = 1.06;
      u.pitch = 1;
      window.speechSynthesis.speak(u);
    }catch(_){}
  }

  function setActiveChoice(container, predicate){
    const choices = Array.from(container.querySelectorAll('.choice'));
    choices.forEach(ch=>{
      if (predicate(ch)) ch.classList.add('active');
      else ch.classList.remove('active');
    });
  }

  function buildScenarioChoices(sym){
    scenarioRow.innerHTML = '';
    const list = SCENARIOS_BY_SYM[sym] || [];
    list.forEach(item=>{
      const div = document.createElement('div');
      div.className = 'choice';
      div.tabIndex = 0;
      div.setAttribute('role','button');
      div.dataset.table = item.key;
      div.innerHTML = `<div class="lbl">${item.title}</div><div class="sm">${item.sub}</div>`;
      div.addEventListener('click', ()=>selectTable(item.key));
      div.addEventListener('keydown', (e)=>{
        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); selectTable(item.key); }
      });
      scenarioRow.appendChild(div);
    });
  }

  function selectSym(sym){
    selectedSym = sym;
    setActiveChoice(symptomRow, ch => ch.dataset.sym === sym);
    buildScenarioChoices(sym);
    selectedTableKey = null;
    resultBox.style.display = 'none';
    promptBox.textContent = "Select a scenario to generate a prompt‚Ä¶";
    toast(`Selected: Symptoms of ischemia = ${sym.toUpperCase()}`);
    speak(`Symptoms of ischemia: ${sym === 'yes' ? 'Yes' : 'No'}. Now choose a clinical scenario.`);
  }

  function getSelectedEmphasis(){
    const emph = Array.from(document.querySelectorAll('.emph:checked')).map(x=>x.value);
    return emph.length ? emph : ["decision impact (what changes)"];
  }

  function computeSitePdfUrl(){
    const base = window.location.href.replace(/[#?].*$/, '').replace(/[^\/]*$/, '');
    return base + "chestpaintest.pdf";
  }

  function buildAIPrompt(tableKey){
    const t = TABLES[tableKey];
    const emph = getSelectedEmphasis();
    const sitePdf = computeSitePdfUrl();

    return [
`SYSTEM / SAFETY`,
`- This is educational and NOT medical advice.`,
`- You are an AI system and can make mistakes. If uncertain, say so.`,
`- Only use what you can directly read in the PDF; do not guess AUC ratings.`,
`- The user must read the table/footnotes. Encourage verification.`,
``,
`PRIMARY SOURCES (PDF)`,
`- Site PDF (preferred if accessible): ${sitePdf}`,
`- Publisher PDF: ${JACC_PDF}`,
``,
`WHERE TO LOOK`,
`- Use ${t.label} on page ${t.page}.`,
`- Scenario: ${t.scenario}`,
``,
`TASK`,
`1) Open one of the PDF links above and navigate to page ${t.page}.`,
`2) Find ${t.label} exactly and read the relevant rows AND footnotes.`,
`3) Summarize ONLY what the table says for this scenario.`,
`4) Include short direct quotes of the exact row(s) and the key footnote(s).`,
`5) Emphasize: ${emph.join("; ")}.`,
``,
`OUTPUT FORMAT`,
`- 2‚Äì4 sentence plain-language summary`,
`- ‚ÄúWhere to find it‚Äù: page ${t.page}, ${t.label}`,
`- ‚ÄúTable excerpt‚Äù: quote the matching row(s) + footnote snippets (short)`,
`- ‚ÄúInterpretation notes‚Äù: explain how you matched scenario ‚Üí row(s)`,
`- ‚ÄúCaveats‚Äù: remind user to verify in the PDF (AI may be wrong)`,
``,
`STOP CONDITION`,
`If you cannot access the PDF or cannot locate ${t.label}, say so and stop. Do not guess.`
    ].join("\n");
  }

  function selectTable(tableKey){
    selectedTableKey = tableKey;
    setActiveChoice(scenarioRow, ch => ch.dataset.table === tableKey);

    const t = TABLES[tableKey];
    resultLine.textContent = `${t.label} ‚Üí page ${t.page}  |  ${t.scenario}`;
    resultBox.style.display = 'block';

    promptBox.textContent = buildAIPrompt(tableKey);

    toast(`Selected ${t.label} (page ${t.page})`);
    speak(`Selected ${t.label}. I will jump to page ${t.page} in the PDF viewer. Then scroll to the table and read the footnotes.`);
    jumpToPage(t.page);
  }

  async function copyToClipboard(text){
    try{
      await navigator.clipboard.writeText(text);
      return true;
    }catch(_){
      return false;
    }
  }

  async function copyPromptAndOpen(url, label){
    if (!selectedTableKey){
      toast("Select a scenario first (so the prompt knows which table).");
      speak("Select a scenario first.");
      return;
    }
    const prompt = promptBox.textContent || "";
    const ok = await copyToClipboard(prompt);
    if (ok){
      toast(`Prompt copied. Opening ${label}‚Ä¶`);
      window.open(url, "_blank");
      speak(`Prompt copied. Opening ${label}. Paste with Control V or Command V. Then ask it to open the PDF and quote the table rows and footnotes. Verify in the PDF.`);
    } else {
      toast("Clipboard blocked. Select and copy the prompt manually, then open the model.");
      window.open(url, "_blank");
      speak("Clipboard blocked. Please copy the prompt manually, then paste it into the model.");
    }
  }

  function clearPdf(){
    pdfScroll.innerHTML = "";
    renderedPages = new Set();
  }

  function showLoading(msg){
    pdfScroll.innerHTML = "";
    const d = document.createElement('div');
    d.className = 'loading';
    d.textContent = msg;
    pdfScroll.appendChild(d);
  }

  async function loadPdf(){
    const path = (pdfPathEl.value || "").trim() || LOCAL_PDF_DEFAULT;
    showLoading("Loading PDF‚Ä¶");
    try{
      pdfDoc = await pdfjsLib.getDocument(path).promise;
      toast(`Loaded PDF (${pdfDoc.numPages} pages).`);
      return true;
    }catch(err){
      console.error(err);
      pdfDoc = null;
      showLoading("PDF failed to load. Check the PDF path (and that chestpaintest.pdf exists).");
      toast("PDF failed to load.");
      speak("PDF failed to load. Check the PDF file path.");
      return false;
    }
  }

  function computeScaleForWidth(pageViewportWidth){
    const containerWidth = pdfScroll.clientWidth || 900;
    const target = Math.max(320, containerWidth - 40);
    let scale = target / pageViewportWidth;
    scale = Math.max(0.6, Math.min(scale, 2.2));
    return scale;
  }

  async function renderPage(pageNumber){
    if (!pdfDoc) return;
    if (renderedPages.has(pageNumber)) return;

    const page = await pdfDoc.getPage(pageNumber);
    const unscaled = page.getViewport({ scale: 1.0 });
    const scale = computeScaleForWidth(unscaled.width);
    const viewport = page.getViewport({ scale });

    const card = document.createElement('div');
    card.className = 'pageCard';
    card.id = `pdf-page-${pageNumber}`;
    card.dataset.page = String(pageNumber);

    const hdr = document.createElement('div');
    hdr.className = 'pageHdr';
    hdr.innerHTML = `<div class="pageNum">Page ${pageNumber}</div><div class="pill">scroll target</div>`;
    card.appendChild(hdr);

    const wrap = document.createElement('div');
    wrap.className = 'canvasWrap';

    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d', { alpha: false });

    canvas.width = Math.floor(viewport.width);
    canvas.height = Math.floor(viewport.height);

    wrap.appendChild(canvas);
    card.appendChild(wrap);
    pdfScroll.appendChild(card);

    await page.render({ canvasContext: ctx, viewport }).promise;
    renderedPages.add(pageNumber);
  }

  async function renderRange(startPage, endPage){
    if (!pdfDoc){
      const ok = await loadPdf();
      if (!ok) return;
    }
    clearPdf();
    showLoading(`Rendering pages ${startPage}‚Äì${endPage}‚Ä¶`);
    clearPdf();
    for (let p = startPage; p <= endPage; p++){
      await renderPage(p);
    }
    toast(`Rendered pages ${startPage}‚Äì${endPage}.`);
  }

  async function renderAll(){
    if (!pdfDoc){
      const ok = await loadPdf();
      if (!ok) return;
    }
    clearPdf();
    showLoading("Rendering all pages‚Ä¶");
    clearPdf();
    for (let p = 1; p <= pdfDoc.numPages; p++){
      await renderPage(p);
      if (p % 3 === 0) await new Promise(r => setTimeout(r, 0));
    }
    toast("Rendered all pages.");
  }

  async function ensurePageRendered(pageNumber){
    if (renderedPages.has(pageNumber)) return;
    if (!pdfDoc){
      const ok = await loadPdf();
      if (!ok) return;
    }
    const start = Math.max(1, pageNumber - 1);
    const end = Math.min(pdfDoc.numPages, pageNumber + 1);
    await renderRange(start, end);
  }

  async function jumpToPage(pageNumber){
    await ensurePageRendered(pageNumber);
    const el = document.getElementById(`pdf-page-${pageNumber}`);
    if (!el){
      toast(`Page ${pageNumber} not rendered yet.`);
      return;
    }
    el.scrollIntoView({ behavior: 'smooth', block: 'start' });
    toast(`Jumped to page ${pageNumber}. Scroll to the table.`);
  }

  function openPdfAtPage(pageNumber){
    const base = computeSitePdfUrl();
    window.open(`${base}#page=${pageNumber}`, "_blank");
  }

  Array.from(symptomRow.querySelectorAll('.choice')).forEach(ch=>{
    ch.addEventListener('click', ()=>selectSym(ch.dataset.sym));
    ch.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); selectSym(ch.dataset.sym); }
    });
  });

  jumpBtn.addEventListener('click', ()=>{
    if (!selectedTableKey){
      toast("Pick a scenario first.");
      speak("Pick a scenario first.");
      return;
    }
    jumpToPage(TABLES[selectedTableKey].page);
    speak("Jumped. Scroll to the table and read the footnotes.");
  });

  openPdfNewTabBtn.addEventListener('click', ()=>{
    const page = selectedTableKey ? TABLES[selectedTableKey].page : 1;
    openPdfAtPage(page);
    speak(`Opened the PDF in a new tab at page ${page}.`);
  });

  copilotBtn.addEventListener('click', ()=>copyPromptAndOpen(COPILOT_URL, "Copilot"));
  chatgptBtn.addEventListener('click', ()=>copyPromptAndOpen(CHATGPT_URL, "ChatGPT"));
  claudeBtn.addEventListener('click', ()=>copyPromptAndOpen(CLAUDE_URL, "Claude"));
  geminiBtn.addEventListener('click', ()=>copyPromptAndOpen(GEMINI_URL, "Gemini"));

  Array.from(document.querySelectorAll('.emph')).forEach(cb=>{
    cb.addEventListener('change', ()=>{
      if (selectedTableKey) promptBox.textContent = buildAIPrompt(selectedTableKey);
    });
  });

  renderTablesBtn.addEventListener('click', async ()=>{
    await loadPdf();
    await renderRange(8, 14);
    speak("Rendered pages eight through fourteen. Jumps will be fast now.");
  });

  renderAllBtn.addEventListener('click', async ()=>{
    await loadPdf();
    await renderAll();
    speak("Rendered all pages. You can scroll the full document.");
  });

  // init
  pdfPathEl.value = LOCAL_PDF_DEFAULT;

  const sitePdf = computeSitePdfUrl();
  sitePdfUrlEl.textContent = sitePdf;
  directPdfLinkEl.textContent = sitePdf;

  await loadPdf();
  await renderRange(8, 14);
  selectSym('yes');
</script>
</body>
</html>
