<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CCD AUC Testing Calculator â€” 2023 Multimodality Appropriate Use Criteria</title>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --bg: #f0f1f3;
      --surface: #ffffff;
      --text: #1a1a2e;
      --muted: #6c6e7e;
      --border: #d4d6de;
      --green: #16a34a;
      --green-bg: #dcfce7;
      --green-border: #86efac;
      --yellow: #b45309;
      --yellow-bg: #fef9c3;
      --yellow-border: #fde047;
      --red: #dc2626;
      --red-bg: #fee2e2;
      --red-border: #fca5a5;
      --na-bg: #f1f1f4;
      --na-border: #e0e0e6;
      --accent: #2563eb;
      --accent-dark: #1d4ed8;
      --mono: 'IBM Plex Mono', ui-monospace, monospace;
      --sans: 'IBM Plex Sans', system-ui, sans-serif;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: var(--sans);
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      min-height: 100vh;
    }

    /* ---- HEADER ---- */
    .header {
      background: #1a1a2e;
      color: #e2e4ef;
      padding: 18px 24px;
      border-bottom: 3px solid var(--accent);
    }
    .header-inner { max-width: 1400px; margin: 0 auto; }
    .header h1 {
      font-size: 1.1rem;
      font-weight: 700;
      letter-spacing: .03em;
      color: #fff;
    }
    .header .sub {
      font-size: .82rem;
      color: #9ca3c0;
      margin-top: 4px;
    }
    .header .links {
      margin-top: 8px;
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      font-size: .78rem;
    }
    .header a {
      color: #93c5fd;
      text-decoration: none;
      font-weight: 600;
    }
    .header a:hover { text-decoration: underline; }

    /* ---- MAIN LAYOUT ---- */
    .main { max-width: 1400px; margin: 0 auto; padding: 16px; }

    /* ---- CONTROLS ---- */
    .controls {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .controls-grid {
      display: grid;
      grid-template-columns: 200px 1fr;
      gap: 12px;
      align-items: start;
    }
    @media (max-width: 700px) {
      .controls-grid { grid-template-columns: 1fr; }
    }
    label.ctrl-label {
      display: block;
      font-size: .75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .06em;
      color: var(--muted);
      margin-bottom: 5px;
    }
    select, input[type="text"], textarea {
      width: 100%;
      font-family: var(--sans);
      font-size: .9rem;
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: #fff;
      color: var(--text);
      outline: none;
    }
    select:focus, input:focus, textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(37,99,235,.12);
    }
    textarea { min-height: 60px; resize: vertical; }

    /* Sub-scenario select */
    .sub-scenario-wrap {
      margin-top: 12px;
      padding: 12px;
      background: #f8f9fb;
      border: 1px solid var(--border);
      border-radius: 8px;
    }

    /* ---- RESULTS TABLE ---- */
    .results-panel {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      overflow-x: auto;
    }
    .results-panel h2 {
      font-size: .95rem;
      font-weight: 700;
      margin-bottom: 4px;
    }
    .results-panel .scenario-desc {
      font-size: .82rem;
      color: var(--muted);
      margin-bottom: 12px;
    }

    .ratings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      gap: 8px;
    }
    .rating-card {
      border-radius: 8px;
      padding: 10px;
      text-align: center;
      border: 2px solid;
      transition: transform .12s;
    }
    .rating-card:hover { transform: translateY(-2px); }
    .rating-card.A {
      background: var(--green-bg);
      border-color: var(--green-border);
    }
    .rating-card.M {
      background: var(--yellow-bg);
      border-color: var(--yellow-border);
    }
    .rating-card.R {
      background: var(--red-bg);
      border-color: var(--red-border);
    }
    .rating-card.NA {
      background: var(--na-bg);
      border-color: var(--na-border);
      opacity: .5;
    }
    .rating-card .modality {
      font-size: .72rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .04em;
      color: var(--muted);
      margin-bottom: 4px;
    }
    .rating-card .rating-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      font-weight: 700;
      font-size: 1rem;
      color: #fff;
      margin-bottom: 4px;
    }
    .rating-card.A .rating-badge { background: var(--green); }
    .rating-card.M .rating-badge { background: var(--yellow); }
    .rating-card.R .rating-badge { background: var(--red); }
    .rating-card.NA .rating-badge { background: #bbb; }
    .rating-card .score {
      font-family: var(--mono);
      font-size: .82rem;
      font-weight: 600;
    }
    .rating-card.A .score { color: var(--green); }
    .rating-card.M .score { color: var(--yellow); }
    .rating-card.R .score { color: var(--red); }
    .rating-card.NA .score { color: #999; }
    .rating-card .rating-label {
      font-size: .68rem;
      color: var(--muted);
      margin-top: 2px;
    }

    /* ---- LEGEND ---- */
    .legend {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      margin-bottom: 12px;
      font-size: .78rem;
      font-weight: 600;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .legend-dot {
      width: 14px;
      height: 14px;
      border-radius: 50%;
    }
    .legend-dot.A { background: var(--green); }
    .legend-dot.M { background: var(--yellow); }
    .legend-dot.R { background: var(--red); }

    /* ---- PROMPT SECTION ---- */
    .prompt-panel {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .prompt-panel h2 {
      font-size: .95rem;
      font-weight: 700;
      margin-bottom: 8px;
    }
    .emphasis-chips {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .emp-chip {
      padding: 6px 12px;
      border-radius: 999px;
      font-size: .78rem;
      font-weight: 700;
      cursor: pointer;
      border: 2px solid var(--border);
      background: #fff;
      color: var(--text);
      user-select: none;
      transition: all .15s;
    }
    .emp-chip:hover { border-color: var(--accent); }
    .emp-chip.active {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }
    .prompt-output {
      background: #1a1a2e;
      color: #c8cce0;
      font-family: var(--mono);
      font-size: .78rem;
      line-height: 1.55;
      padding: 12px;
      border-radius: 8px;
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 300px;
      overflow: auto;
      margin-top: 10px;
    }
    .btn-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .btn {
      font-family: var(--sans);
      padding: 8px 14px;
      border: none;
      border-radius: 8px;
      font-size: .82rem;
      font-weight: 700;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .btn-primary { background: var(--accent); color: #fff; }
    .btn-primary:hover { background: var(--accent-dark); }
    .btn-secondary { background: #e5e7eb; color: var(--text); }
    .btn-secondary:hover { background: #d1d5db; }

    .disclaimer {
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      border-radius: 8px;
      padding: 10px;
      font-size: .78rem;
      color: #1e40af;
      margin-bottom: 12px;
    }

    .toast {
      position: fixed;
      bottom: 18px;
      right: 18px;
      background: #1a1a2e;
      color: #fff;
      padding: 10px 16px;
      border-radius: 8px;
      font-weight: 700;
      font-size: .82rem;
      z-index: 9999;
      box-shadow: 0 8px 24px rgba(0,0,0,.3);
    }

    .note-text {
      font-size: .75rem;
      color: var(--muted);
      margin-top: 6px;
      font-style: italic;
    }
  </style>
</head>
<body>

<div class="header">
  <div class="header-inner">
    <h1>ACC/AHA 2023 Multimodality AUC â€” Chronic Coronary Disease Testing Calculator</h1>
    <div class="sub">Interactive lookup for Tables 1.1â€“2.4. Shows appropriateness ratings (A / M / R) by test modality for each clinical scenario. <b>Not medical advice.</b></div>
    <div class="links">
      <a href="https://www.jacc.org/doi/epdf/10.1016/j.jacc.2023.03.410" target="_blank" rel="noopener">ðŸ“„ JACC ePDF (Full Article)</a>
      <a href="https://www.jacc.org/doi/10.1016/j.jacc.2023.03.410" target="_blank" rel="noopener">ðŸ“– Article Page</a>
      <a href="chestpaintest.pdf" target="_blank" rel="noopener">ðŸ“‹ Local PDF</a>
      <a href="https://professional.heart.org/en/guidelines-and-statements/prevent-calculator" target="_blank" rel="noopener">ðŸ§® AHA PREVENTâ„¢ Risk Calculator</a>
    </div>
  </div>
</div>

<div class="main">
  <!-- DISCLAIMER -->
  <div class="disclaimer">
    <b>âš  Not medical advice.</b> This tool displays ratings from the 2023 ACC/AHA/ASE/ASNC/ASPC/HFSA/HRS/SCAI/SCCT/SCMR/STS Multimodality AUC for Chronic Coronary Disease (JACC 2023;81:2445â€“2467). It does not replace clinical judgment. Read the primary source.
  </div>

  <!-- STEP 1: SELECT SCENARIO -->
  <div class="controls">
    <div style="font-weight:700; font-size:.88rem; margin-bottom:10px;">â‘  Select Clinical Scenario</div>
    <div class="controls-grid">
      <div>
        <label class="ctrl-label" for="sympSel">Symptoms of Ischemia?</label>
        <select id="sympSel">
          <option value="symptomatic">Yes â€” Symptomatic</option>
          <option value="asymptomatic">No â€” Asymptomatic</option>
        </select>
      </div>
      <div>
        <label class="ctrl-label" for="tableSel">Which Table / Category?</label>
        <select id="tableSel"></select>
      </div>
    </div>
    <div class="sub-scenario-wrap">
      <label class="ctrl-label" for="scenarioSel">Specific Clinical Scenario</label>
      <select id="scenarioSel"></select>
    </div>
  </div>

  <!-- STEP 2: RESULTS -->
  <div class="results-panel" id="resultsPanel">
    <h2 id="resultsTitle">Appropriateness Ratings</h2>
    <div class="scenario-desc" id="scenarioDesc"></div>
    <div class="legend">
      <div class="legend-item"><div class="legend-dot A"></div> Appropriate (7â€“9)</div>
      <div class="legend-item"><div class="legend-dot M"></div> May Be Appropriate (4â€“6)</div>
      <div class="legend-item"><div class="legend-dot R"></div> Rarely Appropriate (1â€“3)</div>
    </div>
    <div class="ratings-grid" id="ratingsGrid"></div>
    <div class="note-text" id="tableNote"></div>
  </div>

  <!-- STEP 3: PROMPT BUILDER -->
  <div class="prompt-panel">
    <h2>â‘¡ Payload Prompt Builder</h2>
    <p style="font-size:.82rem; color:var(--muted); margin-bottom:10px;">
      Generate a prompt to paste into an LLM for a guided summary of this scenario from the paper.
    </p>

    <label class="ctrl-label">Emphasis</label>
    <div class="emphasis-chips" id="emphasisChips">
      <div class="emp-chip" data-emp="symptoms">Symptoms</div>
      <div class="emp-chip" data-emp="testing">Testing Strategy</div>
      <div class="emp-chip" data-emp="both" >Symptoms + Testing</div>
      <div class="emp-chip" data-emp="risk">Risk Factors</div>
      <div class="emp-chip" data-emp="notest">When to Defer Testing</div>
    </div>

    <label class="ctrl-label" for="freeEmphasis">Custom Emphasis (optional)</label>
    <input type="text" id="freeEmphasis" placeholder="e.g., focus on metabolic syndrome implications, or clarify CCTA vs stress echo trade-offs"/>

    <label class="ctrl-label" style="margin-top:10px;" for="riskContext">Risk / Patient Context (optional)</label>
    <textarea id="riskContext" placeholder="e.g., 62yo male, DM2, HTN, former smoker, BMI 34, CKD stage 3a"></textarea>

    <div class="btn-row">
      <button class="btn btn-primary" id="buildBtn">ðŸ§  Build Prompt</button>
      <button class="btn btn-secondary" id="copyBtn">ðŸ“‹ Copy Prompt</button>
    </div>

    <div class="prompt-output" id="promptOutput">Select a scenario and click "Build Prompt".</div>
  </div>
</div>

<script>
(() => {
  'use strict';

  // ===================================================================
  // DATA: All tables from the 2023 AUC document
  // Each scenario has: id, text (description), and ratings array
  // Ratings map to columns: ECG, Nuclear, Echo, CMR, CAC, CCTA, Cath, NoTest
  // null = not applicable (grayed out in the paper)
  // Each rating is [letter, score] e.g. ["A", 7]
  // ===================================================================

  const MODALITIES = ["ECG Treadmill", "Stress Nuclear MPI", "Stress Echo", "Stress CMR", "CAC", "CCTA", "Cath", "No Test"];

  const TABLES = {
    // ---- TABLE 1.1 ----
    "1.1": {
      title: "Table 1.1 â€” Symptomatic, No Known CCD, No Prior Testing",
      page: 12,
      note: "CV risk factors: diabetes mellitus, smoking, family history of premature CAD, hypertension, dyslipidemia.",
      scenarios: [
        { id: 1, text: "Less-likely anginal symptoms with a noncardiac explanation",
          r: [["R",3],["R",2],["R",2],["R",2],["R",3],["R",1],["R",1],["A",8]] },
        { id: 2, text: "Less-likely anginal symptoms, age <50 y and 0 or 1 CV risk factor",
          r: [["M",4],["R",3],["R",3],["R",3],["M",4],["R",3],["R",1],["A",7]] },
        { id: 3, text: "Less-likely anginal symptoms, age â‰¥50 y and/or â‰¥2 CV risk factors",
          r: [["M",6],["M",6],["M",6],["M",5],["M",6],["M",5],["R",2],["M",4]] },
        { id: 4, text: "Likely anginal symptoms, age <50 y and 0 or 1 CV risk factor",
          r: [["A",7],["A",7],["A",7],["A",7],["M",6],["A",7],["R",3],["R",3]] },
        { id: 5, text: "Likely anginal symptoms, age â‰¥50 y and/or â‰¥2 CV risk factors",
          r: [["A",7],["A",8],["A",8],["A",7],["M",5],["A",7],["A",7],["R",1]] },
      ]
    },

    // ---- TABLE 1.2 ----
    "1.2": {
      title: "Table 1.2 â€” Symptomatic, No Known CCD, With Prior Testing",
      page: 12,
      note: "Refers to sequential testing as part of continued evaluation. Stress imaging = SPECT, PET, echo, or CMR. Invasive angiography rows refer to diagnostic angiography, not PCI.",
      scenarios: [
        { id: 6, text: "Abnormal ECG",
          r: [["M",4],["A",8],["A",8],["A",8],["M",5],["A",8],["M",5],["M",4]] },
        { id: 7, text: "Normal exercise treadmill test (ET)",
          r: [null,["M",6],["M",6],["M",6],["M",5],["M",6],["R",3],["M",5]] },
        { id: 8, text: "Inconclusive exercise treadmill test (ET)",
          r: [null,["A",8],["A",8],["A",7],["M",5],["A",8],["M",5],["R",3]] },
        { id: 9, text: "Abnormal exercise treadmill test (ET)",
          r: [null,["A",8],["A",8],["A",7],["M",4],["A",8],["A",8],["M",5]] },
        { id: 10, text: "Normal stress imaging",
          r: [["R",1],["R",2],["R",2],["R",2],["M",4],["A",7],["M",5],["M",6]] },
        { id: 11, text: "Mild ischemia on stress imaging",
          r: [["R",1],["R",3],["R",3],["R",3],["R",3],["A",7],["M",6],["M",5]] },
        { id: 12, text: "Inconclusive stress imaging",
          r: [["R",1],["M",5],["M",5],["M",5],["M",4],["A",8],["M",6],["R",3]] },
        { id: 13, text: "Moderate to severe ischemia on stress imaging",
          r: [["R",1],["R",1],["R",1],["R",1],["R",2],["A",7],["A",9],["M",4]] },
        { id: 14, text: "CCTA: no CAD or up to 49% stenosis (CAD-RADS 0â€“2)",
          r: [null,["M",4],["M",5],["M",5],["M",5],["R",1],["R",2],["M",6]] },
        { id: 15, text: "CCTA: moderate stenosis 50â€“69% (CAD-RADS 3)",
          r: [null,["M",6],["A",7],["A",7],["A",7],["R",1],["A",7],["M",5]] },
        { id: 16, text: "CCTA: severe stenosis â‰¥70% (CAD-RADS 4â€“5)",
          r: [null,["M",5],["M",6],["M",6],["M",6],["R",1],["A",8],["M",5]] },
        { id: 17, text: "CCTA: inconclusive (CAD-RADS N)",
          r: [null,["A",7],["A",8],["A",8],["A",8],["R",1],["A",7],["R",3]] },
        { id: 18, text: "CAC score = 0 (CAC-DRS 0)",
          r: [["M",5],["M",6],["M",6],["M",6],null,["M",5],["R",1],["M",5]] },
        { id: 19, text: "CAC score 1â€“99 (CAC-DRS 1)",
          r: [["M",6],["M",5],["M",6],["M",5],null,["M",5],["R",3],["M",5]] },
        { id: 20, text: "CAC score 100â€“299 (CAC-DRS 2)",
          r: [["A",7],["A",7],["A",7],["A",7],null,["A",7],["M",5],["M",4]] },
        { id: 21, text: "CAC score â‰¥300 (CAC-DRS 3)",
          r: [["A",7],["A",7],["A",7],["A",7],null,["M",6],["M",6],["R",3]] },
        { id: 22, text: "Invasive angiography: mild or no CAD and/or normal invasive physiological testing",
          r: [["R",2],["M",3],["R",2],["M",4],["R",1],["R",1],null,["A",7]] },
        { id: 23, text: "Invasive angiography: intermediate severity and/or physiological testing not done",
          r: [["M",5],["A",7],["A",8],["A",7],["R",1],["R",1],null,["M",4]] },
        { id: 24, text: "Invasive angiography: obstructive CAD and/or abnormal invasive physiological testing",
          r: [["R",2],["M",4],["M",4],["M",4],["R",1],["R",1],null,["M",4]] },
      ]
    },

    // ---- TABLE 1.3 ----
    "1.3": {
      title: "Table 1.3 â€” Symptomatic, Prior MI or Revascularization",
      page: 13,
      note: "Anginal symptoms = chest/epigastric/shoulder/arm/jaw pain or pressure with exertion or stress, relieved by rest or nitroglycerin.",
      scenarios: [
        { id: 25, text: "Incomplete revascularization",
          r: [["M",4],["A",8],["A",8],["A",7],["R",1],["R",3],["M",6],["M",4]] },
        { id: 26, text: "Prior PCI, symptoms similar to prior ischemic episode and/or anginal symptoms",
          r: [["M",5],["A",8],["A",8],["A",8],["R",1],["M",5],["A",7],["M",5]] },
        { id: 27, text: "Prior PCI, nonanginal symptoms",
          r: [["M",5],["M",6],["M",6],["M",6],["R",1],["M",5],["R",3],["M",6]] },
        { id: 28, text: "Prior CABG, symptoms similar to prior ischemic episode and/or anginal symptoms",
          r: [["M",4],["A",8],["A",8],["A",8],["R",1],["M",6],["A",7],["M",5]] },
        { id: 29, text: "Prior CABG, nonanginal symptoms",
          r: [["M",5],["M",6],["M",6],["M",6],["R",1],["M",6],["R",3],["M",5]] },
        { id: 30, text: "Prior MI, no revascularization, symptoms similar to prior ischemic episode and/or anginal",
          r: [["M",5],["A",8],["A",8],["A",8],["R",1],["A",7],["A",7],["R",3]] },
        { id: 31, text: "Prior MI, no revascularization, nonanginal symptoms",
          r: [["M",5],["M",6],["M",6],["M",6],["R",1],["M",6],["M",5],["M",5]] },
        { id: 32, text: "Assessment of myocardial viability",
          r: [["R",1],["A",8],["A",7],["A",8],["R",1],["R",1],["R",1],null] },
        { id: 33, text: "Prior to cardiac rehabilitation, coronary disease (no new or worsening symptoms)",
          r: [["A",7],["M",5],["M",5],["M",4],["R",1],["R",2],["R",1],["M",4]] },
      ]
    },

    // ---- TABLE 2.1 ----
    "2.1": {
      title: "Table 2.1 â€” Asymptomatic, Without Known ASCVD",
      page: 13,
      note: "Risk calculated using the ASCVD risk estimator. See Table C for risk-enhancing factors.",
      scenarios: [
        { id: 34, text: "Low ASCVD risk <5%",
          r: [["R",2],["R",1],["R",1],["R",1],["M",4],["R",1],["R",1],["A",8]] },
        { id: 35, text: "Borderline ASCVD risk 5%â€“7.5%",
          r: [["M",4],["R",2],["R",2],["R",2],["A",7],["R",2],["R",1],["A",7]] },
        { id: 36, text: "Borderline ASCVD risk 5%â€“7.5% with risk-enhancing factors",
          r: [["M",4],["R",3],["R",3],["R",3],["A",7],["R",3],["R",1],["A",7]] },
        { id: 37, text: "Intermediate ASCVD risk 7.5%â€“20% with or without risk-enhancing factors",
          r: [["M",5],["R",3],["R",3],["R",3],["A",8],["R",3],["R",1],["M",5]] },
        { id: 38, text: "High ASCVD risk >20%",
          r: [["M",5],["M",4],["M",4],["M",4],["M",6],["M",4],["R",2],["M",5]] },
      ]
    },

    // ---- TABLE 2.2 ----
    "2.2": {
      title: "Table 2.2 â€” Asymptomatic, Prior Revascularization or MI",
      page: 13,
      note: "High risk for silent ischemia: DM with accelerated CAD, CKD, PAD, prior brachytherapy, in-stent restenosis, SVG intervention.",
      scenarios: [
        { id: 39, text: "Incomplete revascularization",
          r: [["M",5],["M",6],["M",6],["M",6],["R",1],["M",4],["R",2],["M",5]] },
        { id: 40, text: "Prior high-risk PCI",
          r: [["M",4],["M",6],["M",5],["M",5],["R",1],["M",4],["R",3],["M",5]] },
        { id: 41, text: "<5 years after CABG",
          r: [["R",2],["R",2],["R",2],["R",2],["R",1],["R",3],["R",1],["A",7]] },
        { id: 42, text: ">5 years after CABG",
          r: [["M",4],["M",4],["M",4],["M",4],["R",1],["M",4],["R",2],["A",7]] },
        { id: 43, text: "<2 years after PCI",
          r: [["R",2],["R",2],["R",2],["R",2],["R",1],["R",2],["R",1],["A",7]] },
        { id: 44, text: ">2 years after PCI",
          r: [["M",5],["M",5],["M",5],["M",5],["R",1],["M",4],["R",1],["A",7]] },
        { id: 45, text: "Patients at high risk for or with history of silent ischemia",
          r: [["M",4],["A",7],["A",7],["A",7],["R",1],["M",5],["R",3],["M",5]] },
        { id: 46, text: "Assessment of myocardial viability",
          r: [["R",1],["A",7],["M",6],["A",7],["R",1],["R",1],["R",1],null] },
        { id: 47, text: "Isolated evaluation of bypass graft patency",
          r: [["R",3],["M",5],["M",5],["M",5],["R",1],["A",7],["R",3],["M",6]] },
      ]
    },

    // ---- TABLE 2.3 ----
    "2.3": {
      title: "Table 2.3 â€” Asymptomatic, Exercise Program or Cardiac Rehabilitation",
      page: 14,
      note: "Exercise ECG column header. Assessing exercise readiness.",
      scenarios: [
        { id: 48, text: "Prior to unsupervised exercise program, without known CCD",
          r: [["M",6],["R",3],["R",3],["R",3],["R",3],["R",1],["R",1],["A",7]] },
        { id: 49, text: "Prior to unsupervised exercise program, with known CCD",
          r: [["A",7],["M",5],["M",5],["M",4],["R",1],["R",2],["R",1],["M",4]] },
        { id: 50, text: "Prior to cardiac rehabilitation",
          r: [["A",7],["M",4],["M",4],["M",4],["R",1],["R",2],["R",1],["M",5]] },
      ]
    },

    // ---- TABLE 2.4 ----
    "2.4": {
      title: "Table 2.4 â€” Other CV Conditions, No Symptoms of Ischemia",
      page: 14,
      note: "Frequent PVCs = >30/hr. Sustained VT = >100 bpm lasting >30s. HF = stages Bâ€“D.",
      scenarios: [
        // Heart Failure
        { id: 51, text: "Newly diagnosed HFpEF (LV function previously assessed, no prior CAD evaluation)",
          r: [["M",4],["A",7],["A",8],["A",7],["R",3],["A",7],["M",6],["R",3]] },
        { id: 52, text: "Newly diagnosed HFrEF (LV function previously assessed, no prior CAD evaluation)",
          r: [["M",4],["A",7],["A",8],["A",8],["R",2],["A",7],["A",8],["R",1]] },
        { id: 53, text: "Screening for transplant vasculopathy",
          r: [["R",3],["A",7],["A",7],["A",7],["R",1],["A",7],["A",8],null] },
        // Arrhythmias
        { id: 54, text: "Infrequent PVCs (â‰¤30/hr), no prior cardiac evaluation",
          r: [["M",4],["R",2],["R",2],["R",2],["R",2],["R",1],["R",1],["A",8]] },
        { id: 55, text: "Frequent PVCs (>30/hr) or nonsustained VT, no prior cardiac evaluation",
          r: [["A",7],["A",7],["A",7],["A",7],["R",3],["M",6],["M",5],["M",4]] },
        { id: 56, text: "Paroxysmal supraventricular tachycardia",
          r: [["M",5],["R",2],["R",3],["R",3],["R",1],["R",2],["R",1],["M",5]] },
        { id: 57, text: "New-onset atrial fibrillation / flutter",
          r: [["M",5],["R",3],["R",3],["R",3],["R",2],["R",3],["R",1],["M",5]] },
        { id: 58, text: "Prior to antiarrhythmic therapy in patients with high global CAD risk",
          r: [["M",6],["A",7],["A",7],["A",7],["R",3],["A",7],["R",3],["R",3]] },
        { id: 59, text: "Exercise-induced VT",
          r: [["A",7],["A",7],["A",8],["A",7],["R",2],["A",7],["A",7],["R",1]] },
        { id: 60, text: "Sustained VT",
          r: [["A",7],["A",7],["A",7],["A",7],["R",2],["A",7],["A",7],["R",1]] },
        { id: 61, text: "Ventricular fibrillation",
          r: [["M",4],["A",7],["A",7],["A",7],["R",1],["A",7],["A",8],["R",1]] },
        // Syncope
        { id: 62, text: "Syncope: initial evaluation suggests CV abnormalities",
          r: [["A",7],["A",7],["A",7],["A",7],["R",3],["M",6],["M",5],["R",3]] },
        { id: 63, text: "Syncope: initial evaluation suggests other etiology",
          r: [["M",4],["R",3],["M",4],["R",3],["R",2],["R",2],["R",1],["M",6]] },
        // Cardio-oncology
        { id: 64, text: "Prior chest radiation, no symptoms, >5 years ago",
          r: [["M",4],["M",4],["M",6],["M",5],["M",6],["M",6],["R",2],["M",5]] },
      ]
    }
  };

  // Table groupings by symptom status
  const TABLE_GROUPS = {
    symptomatic: [
      { key: "1.1", label: "Table 1.1 â€” No prior testing" },
      { key: "1.2", label: "Table 1.2 â€” With prior testing" },
      { key: "1.3", label: "Table 1.3 â€” Prior MI or Revascularization" },
    ],
    asymptomatic: [
      { key: "2.1", label: "Table 2.1 â€” No known ASCVD (risk screening)" },
      { key: "2.2", label: "Table 2.2 â€” Prior Revascularization or MI" },
      { key: "2.3", label: "Table 2.3 â€” Exercise Program / Cardiac Rehab" },
      { key: "2.4", label: "Table 2.4 â€” Other CV Conditions (HF, arrhythmia, syncope)" },
    ]
  };

  const RATING_LABELS = {
    A: "Appropriate",
    M: "May Be Appropriate",
    R: "Rarely Appropriate"
  };

  const EMPHASIS_MAP = {
    symptoms: "Focus on symptom classification and how symptom type/likelihood drives the testing decision in this scenario.",
    testing: "Focus on the testing strategy: which modalities are appropriate, which are rarely appropriate, and the reasoning behind the hierarchy.",
    both: "Provide a balanced summary covering both symptom classification and testing strategy, and how they interact.",
    risk: "Emphasize how cardiovascular risk factors (traditional and risk-enhancing) influence testing decisions in this scenario.",
    notest: "Focus on when testing can safely be deferred ('No Test' column), the evidence behind deferral, and shared decision-making."
  };

  // ===================================================================
  // DOM ELEMENTS
  // ===================================================================
  const sympSel = document.getElementById('sympSel');
  const tableSel = document.getElementById('tableSel');
  const scenarioSel = document.getElementById('scenarioSel');
  const resultsTitle = document.getElementById('resultsTitle');
  const scenarioDesc = document.getElementById('scenarioDesc');
  const ratingsGrid = document.getElementById('ratingsGrid');
  const tableNote = document.getElementById('tableNote');
  const emphasisChips = document.getElementById('emphasisChips');
  const freeEmphasis = document.getElementById('freeEmphasis');
  const riskContext = document.getElementById('riskContext');
  const buildBtn = document.getElementById('buildBtn');
  const copyBtn = document.getElementById('copyBtn');
  const promptOutput = document.getElementById('promptOutput');

  // ===================================================================
  // EMPHASIS STATE
  // ===================================================================
  let activeEmphasis = new Set();

  emphasisChips.addEventListener('click', e => {
    const chip = e.target.closest('.emp-chip');
    if (!chip) return;
    const key = chip.dataset.emp;
    if (activeEmphasis.has(key)) {
      activeEmphasis.delete(key);
      chip.classList.remove('active');
    } else {
      activeEmphasis.add(key);
      chip.classList.add('active');
    }
  });

  // ===================================================================
  // POPULATE DROPDOWNS
  // ===================================================================
  function populateTables() {
    const group = sympSel.value;
    tableSel.innerHTML = '';
    TABLE_GROUPS[group].forEach(t => {
      const opt = document.createElement('option');
      opt.value = t.key;
      opt.textContent = t.label;
      tableSel.appendChild(opt);
    });
    populateScenarios();
  }

  function populateScenarios() {
    const tableKey = tableSel.value;
    const table = TABLES[tableKey];
    scenarioSel.innerHTML = '';
    table.scenarios.forEach(s => {
      const opt = document.createElement('option');
      opt.value = s.id;
      opt.textContent = `#${s.id}. ${s.text}`;
      scenarioSel.appendChild(opt);
    });
    renderRatings();
  }

  // ===================================================================
  // RENDER RATINGS
  // ===================================================================
  function renderRatings() {
    const tableKey = tableSel.value;
    const table = TABLES[tableKey];
    const scenarioId = parseInt(scenarioSel.value);
    const scenario = table.scenarios.find(s => s.id === scenarioId);
    if (!scenario) return;

    resultsTitle.textContent = table.title;
    scenarioDesc.textContent = `Scenario #${scenario.id}: ${scenario.text}`;
    tableNote.textContent = table.note;

    ratingsGrid.innerHTML = '';

    // Sort ratings: A first (by score desc), then M (by score desc), then R (by score desc), NA last
    const indexed = scenario.r.map((rating, i) => ({
      modality: MODALITIES[i],
      rating: rating // [letter, score] or null
    }));

    // Separate into buckets
    const buckets = { A: [], M: [], R: [], NA: [] };
    indexed.forEach(item => {
      if (!item.rating) {
        buckets.NA.push(item);
      } else {
        buckets[item.rating[0]].push(item);
      }
    });

    // Sort each bucket by score descending
    ['A', 'M', 'R'].forEach(k => {
      buckets[k].sort((a, b) => b.rating[1] - a.rating[1]);
    });

    const sorted = [...buckets.A, ...buckets.M, ...buckets.R, ...buckets.NA];

    sorted.forEach(item => {
      const card = document.createElement('div');
      const letter = item.rating ? item.rating[0] : 'NA';
      const score = item.rating ? item.rating[1] : 'â€”';
      card.className = `rating-card ${letter}`;

      card.innerHTML = `
        <div class="modality">${item.modality}</div>
        <div class="rating-badge">${letter === 'NA' ? 'â€”' : letter}</div>
        <div class="score">${letter === 'NA' ? 'N/A' : `Score: ${score}`}</div>
        <div class="rating-label">${letter === 'NA' ? 'Not Applicable' : RATING_LABELS[letter]}</div>
      `;
      ratingsGrid.appendChild(card);
    });
  }

  // ===================================================================
  // BUILD PROMPT
  // ===================================================================
  function buildPrompt() {
    const tableKey = tableSel.value;
    const table = TABLES[tableKey];
    const scenarioId = parseInt(scenarioSel.value);
    const scenario = table.scenarios.find(s => s.id === scenarioId);
    if (!scenario) return '';

    // Build ratings summary for the prompt
    const ratingSummary = scenario.r.map((r, i) => {
      if (!r) return `  ${MODALITIES[i]}: N/A`;
      return `  ${MODALITIES[i]}: ${r[0]} (${r[1]}) â€” ${RATING_LABELS[r[0]]}`;
    }).join('\n');

    // Emphasis
    const emphParts = [];
    activeEmphasis.forEach(key => {
      emphParts.push(EMPHASIS_MAP[key]);
    });
    const freeText = freeEmphasis.value.trim();
    if (freeText) emphParts.push(freeText);
    const emphasisBlock = emphParts.length > 0
      ? emphParts.join('\n')
      : "Provide a general summary of the scenario and testing options.";

    const patientCtx = riskContext.value.trim() || "(none provided)";

    const prompt = `SYSTEM / ROLE
You are an evidence-grounded medical education assistant. You must NOT give medical advice. Summarize what the paper says, cite the table/page, and urge the user to read the primary source.

PRIMARY SOURCE
ACC/AHA/ASE/ASNC/ASPC/HFSA/HRS/SCAI/SCCT/SCMR/STS 2023 Multimodality AUC for Chronic Coronary Disease
JACC 2023;81(25):2445â€“2467
ePDF: https://www.jacc.org/doi/epdf/10.1016/j.jacc.2023.03.410

CLINICAL SCENARIO
Table: ${table.title} (PDF page ${table.page})
Scenario #${scenario.id}: ${scenario.text}

RATINGS FROM THE TABLE
${ratingSummary}

PATIENT CONTEXT (for emphasis only â€” not a diagnosis)
${patientCtx}

TASK
1. Summarize the clinical scenario and what the table is trying to guide.
2. List the test modalities in order of appropriateness (Appropriate â†’ May Be Appropriate â†’ Rarely Appropriate).
3. Highlight the key decision factors for this scenario.

EMPHASIS / ANGLE
${emphasisBlock}

4. Include a "Caveats / Limitations" section.
5. Include "Where in the Paper" citing Table ${tableKey}, page ${table.page}.
6. End with: "This is not medical advice. Please read the primary source."`;

    promptOutput.textContent = prompt;
    return prompt;
  }

  // ===================================================================
  // CLIPBOARD + TOAST
  // ===================================================================
  function toast(msg, ms = 2200) {
    const t = document.createElement('div');
    t.className = 'toast';
    t.textContent = msg;
    document.body.appendChild(t);
    setTimeout(() => t.remove(), ms);
  }

  async function copyToClipboard(text) {
    try {
      await navigator.clipboard.writeText(text);
      return true;
    } catch { return false; }
  }

  buildBtn.addEventListener('click', () => {
    buildPrompt();
    toast('Prompt built.');
  });

  copyBtn.addEventListener('click', async () => {
    const text = promptOutput.textContent;
    if (!text || text.startsWith('Select a scenario')) {
      buildPrompt();
    }
    const ok = await copyToClipboard(promptOutput.textContent);
    toast(ok ? 'Copied to clipboard.' : 'Copy failed â€” select manually.');
  });

  // ===================================================================
  // WIRE EVENTS
  // ===================================================================
  sympSel.addEventListener('change', populateTables);
  tableSel.addEventListener('change', populateScenarios);
  scenarioSel.addEventListener('change', renderRatings);

  // ===================================================================
  // INIT
  // ===================================================================
  populateTables();
})();
</script>
</body>
</html>
