<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ABX Docs Extractor ‚Äî OpenEvidence (Left) + Copilot (Right) ‚Äî v1.3</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root{
      --bg:#f3f4f6;
      --panel:#ffffff;
      --accent:#2563eb;
      --accent2:#1d4ed8;
      --border:#d1d5db;
      --text:#111827;
      --muted:#6b7280;
      --shadow:0 10px 25px rgba(15,23,42,.12);
      --r-lg:16px;
      --r-md:12px;
      --r-sm:10px;
    }
    *{ box-sizing:border-box; margin:0; padding:0; }
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top left,#e0f2fe 0,#f3f4f6 40%,#e5e7eb 100%);
      color:var(--text);
      min-height:100vh;
      padding:16px;
    }
    .wrap{ max-width:1280px; margin:0 auto; }
    .header{
      background:linear-gradient(135deg,#fff,#e0f2fe);
      border-radius:18px;
      padding:14px 16px;
      box-shadow:0 16px 40px rgba(15,23,42,.15);
      border:1px solid rgba(148,163,184,.35);
      position:sticky; top:8px; z-index:10;
      backdrop-filter:blur(10px);
    }
    .htop{ display:flex; justify-content:space-between; align-items:flex-start; gap:10px; flex-wrap:wrap; }
    .title{
      font-size:1.05rem; font-weight:900; letter-spacing:.04em;
      text-transform:uppercase; color:var(--accent2);
    }
    .subtitle{ font-size:.9rem; color:var(--muted); margin-top:6px; line-height:1.35; }

    .actions{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 12px; border-radius:999px;
      border:1px solid rgba(37,99,235,.25);
      background:#fff;
      color:var(--accent2);
      font-weight:900; font-size:.82rem;
      text-decoration:none;
      box-shadow:0 6px 16px rgba(37,99,235,.12);
      transition:transform .15s ease, box-shadow .15s ease;
      white-space:nowrap;
      cursor:pointer;
    }
    .pill:hover{ transform:translateY(-1px); box-shadow:0 10px 22px rgba(37,99,235,.18); }

    .tooltipWrap{ position:relative; display:inline-flex; }
    .tooltipWrap:hover .tip{
      opacity:1; transform:translateY(0);
      pointer-events:auto;
    }
    .tip{
      position:absolute;
      top:120%;
      right:0;
      width:min(420px, 86vw);
      background:#111827;
      color:#fff;
      border-radius:12px;
      padding:10px 12px;
      font-size:.82rem;
      line-height:1.35;
      box-shadow:0 14px 40px rgba(0,0,0,.35);
      opacity:0;
      transform:translateY(-6px);
      pointer-events:none;
      transition:opacity .15s ease, transform .15s ease;
      z-index:999;
    }

    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:14px;
    }
    @media (max-width:1020px){ .grid{ grid-template-columns:1fr; } }

    .panel{
      background:var(--panel);
      border-radius:var(--r-lg);
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      padding:14px;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .phead{ display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; }
    .ptitle{ font-weight:900; display:flex; align-items:center; gap:8px; }
    .step{
      width:26px; height:26px; border-radius:999px;
      display:inline-flex; align-items:center; justify-content:center;
      background:var(--accent); color:#fff; font-weight:900;
      font-size:.85rem;
    }
    .hint{
      font-size:.8rem;
      color:var(--muted);
      line-height:1.35;
      white-space:pre-wrap;
    }

    fieldset{
      border:1px solid var(--border);
      background:#f9fafb;
      border-radius:var(--r-md);
      padding:10px;
    }
    legend{
      padding:0 6px;
      font-size:.78rem;
      font-weight:900;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.08em;
    }
    label{ display:block; font-weight:900; font-size:.86rem; margin-top:8px; }
    select, input[type="number"], input[type="text"], textarea{
      width:100%;
      margin-top:6px;
      padding:9px 10px;
      border:1px solid var(--border);
      border-radius:var(--r-sm);
      font-size:.92rem;
      line-height:1.45;
      font-family:inherit;
      background:#fff;
    }
    textarea{ min-height:95px; resize:vertical; }
    .row2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    @media (max-width:640px){ .row2{ grid-template-columns:1fr; } }

    .btnRow{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .btn{
      flex:1;
      min-width:220px;
      padding:10px 10px;
      border:none;
      border-radius:10px;
      font-weight:900;
      cursor:pointer;
      transition:all .15s ease;
      display:flex; align-items:center; justify-content:center; gap:8px;
    }
    .primary{ background:var(--accent); color:#fff; }
    .primary:hover{ background:var(--accent2); transform:translateY(-1px); box-shadow:0 6px 16px rgba(37,99,235,.30); }
    .secondary{ background:#e5e7eb; color:var(--text); min-width:140px; }
    .secondary:hover{ background:#d1d5db; transform:translateY(-1px); box-shadow:0 3px 8px rgba(15,23,42,.15); }

    .out{
      background:#0f172a;
      color:#e2e8f0;
      border-radius:12px;
      padding:10px;
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      font-size:.82rem;
      line-height:1.5;
      max-height:360px;
      overflow:auto;
      white-space:pre-wrap;
      word-wrap:break-word;
    }

    .toast{
      position:fixed; bottom:18px; right:18px;
      background:#111827; color:#fff;
      padding:10px 16px;
      border-radius:10px;
      box-shadow:0 10px 28px rgba(0,0,0,.35);
      font-size:.88rem;
      font-weight:900;
      z-index:9999;
      max-width:92vw;
    }

    .orgBox{ margin-top:8px; display:grid; gap:8px; }
    .orgRow{
      display:flex; gap:10px; align-items:flex-start;
      padding:8px;
      border:1px solid rgba(209,213,219,.9);
      border-radius:12px;
      background:#fff;
    }
    .orgMain{ flex:1; min-width:0; }
    .orgName{ font-weight:900; font-size:.9rem; }
    .orgTag{ margin-top:3px; font-size:.78rem; color:var(--muted); line-height:1.25; }

    .tooltip{
      position:relative;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:22px; height:22px;
      border-radius:999px;
      border:1px solid rgba(37,99,235,.35);
      color:var(--accent2);
      font-weight:900;
      cursor:help;
      user-select:none;
      flex:0 0 auto;
    }
    .tooltip:hover .tip2{ opacity:1; transform:translateY(0); pointer-events:auto; }
    .tip2{
      position:absolute;
      top:120%;
      right:0;
      width:min(380px, 84vw);
      background:#111827;
      color:#fff;
      border-radius:12px;
      padding:10px 12px;
      font-size:.82rem;
      line-height:1.35;
      box-shadow:0 14px 40px rgba(0,0,0,.35);
      opacity:0;
      transform:translateY(-6px);
      pointer-events:none;
      transition:opacity .15s ease, transform .15s ease;
      z-index:999;
      white-space:pre-wrap;
    }
  </style>
</head>

<body>
<div class="wrap">

  <header class="header">
    <div class="htop">
      <div>
        <div class="title">ABX Docs Extractor v1.3 ‚Äî OpenEvidence (Left) + Copilot (Right)</div>
        <div class="subtitle">
          Left: OpenEvidence ‚Äî facility-agnostic evidence helper (organism sets, option families, duration, monitoring, interactions, renal flags, allergy alternatives, cost + resistance risk).<br>
          Right: Copilot ‚Äî <strong>document extraction only</strong> from facility antibiogram + internal policy (if found).<br>
          <strong>Key change:</strong> Copilot prompt contains <em>no links</em> and does NOT mention a specific table ‚Äî it infers from the organism.
        </div>
      </div>

      <div class="actions">
        <!-- UI links are fine; NOT injected into Copilot prompt -->
        <a class="pill" href="https://upmchs.sharepoint.com/sites/infonet/search/Pages/results.aspx?k=antibiogram#k=antibiogram#l=1033" target="_blank" rel="noopener">üìÑ View antibiograms</a>

        <span class="tooltipWrap">
          <a class="pill" id="get365Btn" href="https://www.microsoft365.com/" target="_blank" rel="noopener">‚úÖ Get 365</a>
          <span class="tip">
            If Copilot doesn't open or you don't have access:
            <br>1) Click <strong>Get 365</strong>
            <br>2) Sign in with your UPMC credentials
            <br>3) Complete activation steps
            <br>Then return and use the right-panel button.
          </span>
        </span>

        <a class="pill" href="https://www.openevidence.com/" target="_blank" rel="noopener">üß† OpenEvidence</a>
        <a class="pill" href="https://www.microsoft365.com/chat" target="_blank" rel="noopener">ü™ü Copilot</a>
      </div>
    </div>
  </header>

  <div class="grid">

    <!-- LEFT: OpenEvidence -->
    <section class="panel">
      <div class="phead">
        <div class="ptitle"><span class="step">1</span> OpenEvidence prompt (auto-updates)</div>
        <div class="btnRow" style="margin-top:0; flex:0 0 auto;">
          <button class="btn primary" id="runOE" type="button">üß† Generate + Copy + Open OpenEvidence</button>
          <button class="btn secondary" id="clearOE" type="button">üßπ Clear</button>
        </div>
      </div>

      <fieldset>
        <legend>What‚Äôs known about the infection (facility-agnostic)</legend>

        <div class="row2">
          <div>
            <label for="oeSetting">Setting</label>
            <select id="oeSetting">
              <option value="Community-acquired">Community-acquired</option>
              <option value="Hospital-acquired / HAI / inpatient-onset">Hospital-acquired / HAI / inpatient-onset</option>
              <option value="Unknown / mixed">Unknown / mixed</option>
            </select>
          </div>
          <div>
            <label for="oeSyndrome">Syndrome / body part</label>
            <select id="oeSyndrome">
              <option value="UTI / urinary tract">UTI / urinary tract</option>
              <option value="Pneumonia / respiratory">Pneumonia / respiratory</option>
              <option value="Skin & soft tissue">Skin & soft tissue</option>
              <option value="Intra-abdominal">Intra-abdominal</option>
              <option value="Bacteremia / sepsis (source unclear)">Bacteremia / sepsis (source unclear)</option>
              <option value="Bone / joint">Bone / joint</option>
              <option value="CNS / meningitis">CNS / meningitis</option>
              <option value="Line/device-related">Line/device-related</option>
              <option value="Other / unclear">Other / unclear</option>
            </select>
          </div>
        </div>

        <div class="row2">
          <div>
            <label for="oeDiabetes">Diabetes</label>
            <select id="oeDiabetes">
              <option value="Unknown">Unknown</option>
              <option value="No">No</option>
              <option value="Yes">Yes</option>
            </select>
          </div>
          <div>
            <label for="oeCrcl">CrCl (mL/min)</label>
            <input id="oeCrcl" type="number" min="0" step="1" placeholder="optional" />
          </div>
        </div>

        <div class="row2">
          <div>
            <label for="oeCdiff">Prior C. diff</label>
            <select id="oeCdiff">
              <option value="Unknown">Unknown</option>
              <option value="No">No known prior C. diff</option>
              <option value="Yes">Prior C. diff</option>
            </select>
          </div>
          <div>
            <label for="oeFungal">Fungal suspected?</label>
            <select id="oeFungal">
              <option value="No">No</option>
              <option value="Maybe">Maybe / consider</option>
              <option value="Yes">Yes</option>
            </select>
          </div>
        </div>

        <label for="oeKnownPathogens">Known/suspected pathogen(s) if any (free text)</label>
        <textarea id="oeKnownPathogens" placeholder="e.g., ‚ÄúE. coli on urine culture‚Äù, ‚ÄúMRSA risk‚Äù, ‚ÄúESBL history‚Äù, ‚ÄúCandida in blood?‚Äù"></textarea>

        <label for="oeClues">Clinical clues / decision info (free text)</label>
        <textarea id="oeClues" placeholder="Include: cultures/stains, imaging, devices/lines, recent antibiotics, immunocompromise, severity, source control, exposures, etc."></textarea>

        <label for="oeAllergy">Allergy severity</label>
        <select id="oeAllergy">
          <option value="None / no known beta-lactam allergy">None / no known beta-lactam allergy</option>
          <option value="Non-severe or unclear (rash/unknown history)">Non-severe or unclear (rash/unknown history)</option>
          <option value="Severe (anaphylaxis or severe cutaneous reaction/SCAR)">Severe (anaphylaxis or severe cutaneous reaction/SCAR)</option>
        </select>

        <label for="oeAllergyDetails">Allergy details (optional)</label>
        <input id="oeAllergyDetails" type="text" placeholder="Optional: drug, reaction, timing, tolerance of cephalosporins, etc." />

        <div class="hint">
This prompt is facility-agnostic. It helps decide organism sets + what to look up next.
        </div>
      </fieldset>

      <fieldset>
        <legend>Prompt preview (auto)</legend>
        <div class="out" id="outOE"></div>
        <div class="hint">Button will: generate ‚Üí copy ‚Üí open OpenEvidence.</div>
      </fieldset>
    </section>

    <!-- RIGHT: Copilot -->
    <section class="panel">
      <div class="phead">
        <div class="ptitle"><span class="step">2</span> Copilot prompt (auto-updates, NO LINKS)</div>
        <div class="btnRow" style="margin-top:0; flex:0 0 auto;">
          <button class="btn primary" id="runCP" type="button">ü™ü Generate + Copy + Open Copilot</button>
          <button class="btn secondary" id="clearCP" type="button">üßπ Clear</button>
        </div>
      </div>

      <fieldset>
        <legend>Facility + organism checklist</legend>

        <label for="cpFacility">Facility (antibiogram PDF)</label>
        <select id="cpFacility"></select>

        <label style="margin-top:10px;">Organisms of interest (check) ‚Äî hover ‚Äú?‚Äù for rough associations</label>
        <div class="orgBox" id="orgBox"></div>

        <div class="hint">
Copilot prompt is minimal, no links, no table labels. It extracts from the correct table/section by organism name.
        </div>
      </fieldset>

      <fieldset>
        <legend>Prompt preview (auto)</legend>
        <div class="out" id="outCP"></div>
        <div class="hint">Button will: generate ‚Üí copy ‚Üí open Copilot.</div>
      </fieldset>
    </section>

  </div>
</div>

<script>
(function(){
  'use strict';

  // UI-only links (not injected into prompts)
  const OE_URL = "https://www.openevidence.com/";
  const COPILOT_URL = "https://www.microsoft365.com/chat";

  // Facilities
  const FACILITIES = [
    { abbr:"MWH", name:"Magee-Womens Hospital", fileHint:"MWH_Antibiogram (PDF)" },
    { abbr:"EAST", name:"UPMC East", fileHint:"EAST_Antibiogram (PDF)" },
    { abbr:"CHP", name:"UPMC Children‚Äôs Hospital of Pittsburgh", fileHint:"CHP_Antibiogram (PDF)" },
    { abbr:"MCK", name:"UPMC McKeesport", fileHint:"MCK_Antibiogram (PDF)" },
    { abbr:"PASS", name:"UPMC Passavant", fileHint:"PASS_Antibiogram (PDF)" },
    { abbr:"JAM", name:"UPMC Jameson", fileHint:"JAM_Antibiogram (PDF)" },
    { abbr:"HRZ", name:"UPMC Horizon", fileHint:"HRZ_Antibiogram (PDF)" },
    { abbr:"HAM", name:"UPMC Hamot", fileHint:"HAM_Antibiogram (PDF)" },
    { abbr:"KANE", name:"UPMC Kane", fileHint:"KANE_Antibiogram (PDF)" },
    { abbr:"NW", name:"UPMC Northwest", fileHint:"NW_Antibiogram (PDF)" },
    { abbr:"CHQ", name:"UPMC Chautauqua", fileHint:"CHQ_Antibiogram (PDF)" },
    { abbr:"PRSH Presbyterian", name:"UPMC Presbyterian", fileHint:"PRSH_Presbyterian_Antibiogram (PDF)" },
    { abbr:"PRSH Shadyside", name:"UPMC Shadyside", fileHint:"PRSH_Shadyside_Antibiogram (PDF)" },
    { abbr:"ALT", name:"UPMC Altoona", fileHint:"ALT_Antibiogram (PDF)" },
    { abbr:"WM", name:"UPMC Williamsport / North Central PA", fileHint:"WM_Antibiogram (PDF)" },
    { abbr:"LH / MUN / WMSP", name:"UPMC North Central PA system sites", fileHint:"LH_MUN_WMSP_Antibiogram (PDF)" },
    { abbr:"SMH", name:"UPMC St. Margaret", fileHint:"SMH_Antibiogram (PDF)" },
  ];

  // Organisms
  // Tooltip = for USER only: rough associations (body site, hosp/community, common risk factors).
  const ORGANISMS = [
    {
      key:"Escherichia coli",
      tag:"Enterobacterales",
      tip:
`Common settings:
- Community: uncomplicated cystitis/pyelo; biliary/IAI
- Hospital: catheter-associated UTI; bacteremia

Body sites:
- Urinary tract, bloodstream, intra-abdominal

Risk factors:
- Urinary obstruction/catheters, recent antibiotics, older age, comorbidities`,
      def:true
    },
    {
      key:"Klebsiella pneumoniae",
      tag:"Enterobacterales",
      tip:
`Common settings:
- Community or hospital; more frequent in healthcare exposure

Body sites:
- Urinary tract, pneumonia (esp. severe), bloodstream, intra-abdominal

Risk factors:
- Diabetes, alcohol use disorder, aspiration risk, devices, prior antibiotics`,
      def:true
    },
    {
      key:"Proteus mirabilis",
      tag:"Enterobacterales",
      tip:
`Common settings:
- Community or hospital; often complicated UTI

Body sites:
- Urinary tract (esp. stones), bloodstream (from urinary source)

Risk factors:
- Urinary catheters, urologic abnormalities, struvite stones`,
      def:true
    },
    {
      key:"Enterobacter cloacae complex",
      tag:"Enterobacterales (AmpC risk)",
      tip:
`Common settings:
- Hospital/healthcare-associated

Body sites:
- Respiratory, urinary, intra-abdominal, bloodstream, devices

Risk factors:
- ICU/long stay, broad-spectrum antibiotics, indwelling devices, surgery`,
      def:true
    },
    {
      key:"Serratia marcescens",
      tag:"Enterobacterales",
      tip:
`Common settings:
- Hospital/healthcare-associated

Body sites:
- Respiratory, urinary, bloodstream, devices/lines

Risk factors:
- Devices/lines, ICU, prior antibiotics, outbreaks/cluster situations`,
      def:true
    },
    {
      key:"Pseudomonas aeruginosa",
      tag:"Non-fermenter",
      tip:
`Common settings:
- Hospital/ICU; sometimes CF/bronchiectasis in community

Body sites:
- Respiratory (VAP/HAP), wounds/burns, urinary (catheters), bloodstream

Risk factors:
- Structural lung disease, recent IV antibiotics, devices, prolonged hospitalization`
    },
    {
      key:"Acinetobacter baumannii",
      tag:"Non-fermenter",
      tip:
`Common settings:
- Hospital/ICU, ventilated patients

Body sites:
- Respiratory, wounds, bloodstream, devices

Risk factors:
- Prolonged ICU stay, mechanical ventilation, broad antibiotics, outbreaks`
    },
    {
      key:"Staphylococcus aureus (MSSA)",
      tag:"Gram-positive",
      tip:
`Common settings:
- Community or hospital

Body sites:
- Skin/soft tissue, bone/joint, bloodstream, endovascular

Risk factors:
- Skin breakdown, IVDU, devices/prosthetics, dialysis, prior colonization`
    },
    {
      key:"MRSA",
      tag:"Gram-positive",
      tip:
`Common settings:
- Community (CA-MRSA SSTI) or hospital (HA-MRSA)

Body sites:
- Skin/soft tissue, pneumonia (risk-based), bloodstream

Risk factors:
- Prior MRSA, recent hospitalization, dialysis, LTCF, IVDU, chronic wounds`
    },
    {
      key:"Enterococcus faecalis",
      tag:"Gram-positive",
      tip:
`Common settings:
- Hospital/healthcare-associated; sometimes community UTI

Body sites:
- Urinary tract, intra-abdominal, bloodstream/endocarditis

Risk factors:
- Urinary instrumentation, GI/GU procedures, antibiotics, elderly/comorbid`
    },
    {
      key:"Enterococcus faecium",
      tag:"Gram-positive (VRE concern)",
      tip:
`Common settings:
- Hospital/ICU

Body sites:
- Bloodstream, intra-abdominal, devices; sometimes urinary

Risk factors:
- Broad antibiotics, prolonged hospitalization, immunocompromise, prior VRE`
    },
    {
      key:"Candida spp.",
      tag:"Fungal",
      tip:
`Common settings:
- Hospital/ICU; candidemia is high-risk

Body sites:
- Bloodstream, intra-abdominal collections; urine often colonization vs infection

Risk factors:
- Central lines, TPN, recent abdominal surgery, broad antibiotics, neutropenia`
    }
  ];

  // DOM (Left)
  const oeSetting = document.getElementById('oeSetting');
  const oeSyndrome = document.getElementById('oeSyndrome');
  const oeDiabetes = document.getElementById('oeDiabetes');
  const oeCrcl = document.getElementById('oeCrcl');
  const oeCdiff = document.getElementById('oeCdiff');
  const oeFungal = document.getElementById('oeFungal');
  const oeKnownPathogens = document.getElementById('oeKnownPathogens');
  const oeClues = document.getElementById('oeClues');
  const oeAllergy = document.getElementById('oeAllergy');
  const oeAllergyDetails = document.getElementById('oeAllergyDetails');
  const outOE = document.getElementById('outOE');
  const runOE = document.getElementById('runOE');
  const clearOE = document.getElementById('clearOE');

  // DOM (Right)
  const cpFacility = document.getElementById('cpFacility');
  const orgBox = document.getElementById('orgBox');
  const outCP = document.getElementById('outCP');
  const runCP = document.getElementById('runCP');
  const clearCP = document.getElementById('clearCP');

  // Utils
  function toast(msg, ms){
    ms = ms || 2400;
    const t = document.createElement('div');
    t.className = 'toast';
    t.textContent = msg;
    document.body.appendChild(t);
    setTimeout(()=>t.remove(), ms);
  }
  function esc(s){ return String(s||"").replace(/\r/g,"").trim(); }

  function selectedOrganisms(){
    const out = [];
    document.querySelectorAll('input[data-org="1"]').forEach(cb=>{
      if(cb.checked) out.push(cb.value);
    });
    return out;
  }
  function facilityObj(){
    const abbr = cpFacility.value;
    return FACILITIES.find(f=>f.abbr===abbr) || FACILITIES[0];
  }

  async function copyText(text){
    if(!text){ toast("Nothing to copy."); return false; }
    try{
      if(navigator.clipboard && navigator.clipboard.writeText){
        await navigator.clipboard.writeText(text);
        return true;
      }
    }catch(e){}
    return false;
  }

  function renderOrganisms(){
    orgBox.innerHTML = "";
    ORGANISMS.forEach(o=>{
      const row = document.createElement('div');
      row.className = "orgRow";

      const cb = document.createElement('input');
      cb.type = "checkbox";
      cb.value = o.key;
      cb.setAttribute("data-org","1");
      cb.checked = !!o.def;

      const main = document.createElement('div');
      main.className = "orgMain";
      const name = document.createElement('div');
      name.className = "orgName";
      name.textContent = o.key;
      const tag = document.createElement('div');
      tag.className = "orgTag";
      tag.textContent = o.tag;
      main.appendChild(name);
      main.appendChild(tag);

      const tt = document.createElement('div');
      tt.className = "tooltip";
      tt.textContent = "?";
      const tip = document.createElement('div');
      tip.className = "tip2";
      tip.textContent = o.tip;
      tt.appendChild(tip);

      row.appendChild(cb);
      row.appendChild(main);
      row.appendChild(tt);
      orgBox.appendChild(row);

      cb.addEventListener('change', ()=>updateCopilotPreview());
    });
  }

  function initFacilities(){
    cpFacility.innerHTML = "";
    FACILITIES.forEach(f=>{
      const opt = document.createElement('option');
      opt.value = f.abbr;
      opt.textContent = `${f.name} ‚Äî ${f.abbr}`;
      cpFacility.appendChild(opt);
    });
    cpFacility.value = "PRSH Shadyside";
  }

  // Prompt builders
  function buildOpenEvidencePrompt(){
    const setting = esc(oeSetting.value);
    const syndrome = esc(oeSyndrome.value);
    const diab = esc(oeDiabetes.value);
    const crcl = esc(oeCrcl.value) || "Unknown";
    const cdiff = esc(oeCdiff.value);
    const fungal = esc(oeFungal.value);
    const known = esc(oeKnownPathogens.value) || "(none provided)";
    const clues = esc(oeClues.value) || "(none provided)";
    const allergy = esc(oeAllergy.value);
    const allergyDetails = esc(oeAllergyDetails.value) || "(none provided)";

    return `Evidence helper (facility-agnostic). No PHI.

WHAT IS KNOWN:
- Setting: ${setting}
- Syndrome/body part: ${syndrome}
- Diabetes: ${diab}
- CrCl (mL/min): ${crcl}
- Prior C. diff: ${cdiff}
- Fungal suspected: ${fungal}

KNOWN/SUSPECTED PATHOGENS (if any):
${known}

CLINICAL CLUES:
${clues}

ALLERGY:
- Severity: ${allergy}
- Details: ${allergyDetails}

REQUEST:
1) Likely organism set(s) for this syndrome + setting + host factors (include resistant phenotype considerations).
2) Antibiotic option families: first-line families + alternatives (esp. if severe beta-lactam allergy).
3) Duration: typical ranges and what extends duration.
4) Monitoring & interactions: major monitoring items + key interaction categories for common options.
5) Stewardship: resistance-selection considerations + cost tiers (low/medium/high) in general terms; include C. diff risk considerations at a high level.

Keep it concise and practical. Avoid patient-specific dosing tables.`;
  }

  // ‚úÖ Copilot prompt: minimal, no links, no table names, organism-driven inference
  function buildCopilotPrompt(){
    const f = facilityObj();
    const orgs = selectedOrganisms();
    const orgBlock = orgs.length ? orgs.map(x=>`- ${x}`).join("\n") : "- (none selected)";

    return `You are helping with DOCUMENT EXTRACTION ONLY (no medical advice, no treatment recommendations).

Go to SharePoint antibiogram area and find the facility antibiogram PDF:
- ${f.fileHint}

Task:
Extract the % susceptible values for these organisms:
${orgBlock}

Output requirements:
1) For EACH organism, list antibiotics in descending order of % susceptible (highest ‚Üí lowest).
2) Use best-guess to indicate which antibiotic may need ID permission. If you find an internal policy/procedure document that explicitly lists restricted/approval antibiotics, cite that document and include its internal SharePoint link.
3) Provide any other relevant high-impact stewardship quotes found in internal stewardship documents (with document title).`;
  }

  // Auto preview updates (debounced)
  let tOE = null, tCP = null;
  function updateOpenEvidencePreview(){
    clearTimeout(tOE);
    tOE = setTimeout(()=>{ outOE.textContent = buildOpenEvidencePrompt(); }, 60);
  }
  function updateCopilotPreview(){
    clearTimeout(tCP);
    tCP = setTimeout(()=>{ outCP.textContent = buildCopilotPrompt(); }, 60);
  }

  // Buttons: generate + copy + open
  async function runOpenEvidence(){
    const prompt = buildOpenEvidencePrompt();
    outOE.textContent = prompt;
    const ok = await copyText(prompt);
    toast(ok ? "Copied ‚úÖ  Opening OpenEvidence‚Ä¶" : "Clipboard blocked ‚Äî prompt updated. Opening OpenEvidence‚Ä¶", 2400);
    window.open(OE_URL, "_blank", "noopener");
  }

  async function runCopilot(){
    const prompt = buildCopilotPrompt();
    outCP.textContent = prompt;
    const ok = await copyText(prompt);
    toast(ok ? "Copied ‚úÖ  Opening Copilot‚Ä¶" : "Clipboard blocked ‚Äî prompt updated. Opening Copilot‚Ä¶", 2400);
    window.open(COPILOT_URL, "_blank", "noopener");
  }

  // Clear buttons
  function clearLeft(){
    oeSetting.value = "Hospital-acquired / HAI / inpatient-onset";
    oeSyndrome.value = "UTI / urinary tract";
    oeDiabetes.value = "Unknown";
    oeCrcl.value = "";
    oeCdiff.value = "Unknown";
    oeFungal.value = "No";
    oeKnownPathogens.value = "";
    oeClues.value = "";
    oeAllergy.value = "None / no known beta-lactam allergy";
    oeAllergyDetails.value = "";
    updateOpenEvidencePreview();
    toast("Left panel reset.");
  }

  function clearRight(){
    cpFacility.value = "PRSH Shadyside";
    document.querySelectorAll('input[data-org="1"]').forEach(cb=>{
      const def = ORGANISMS.find(o=>o.key===cb.value)?.def;
      cb.checked = !!def;
    });
    updateCopilotPreview();
    toast("Right panel reset.");
  }

  // Init
  function init(){
    initFacilities();
    renderOrganisms();

    // Defaults (left)
    oeSetting.value = "Hospital-acquired / HAI / inpatient-onset";
    oeSyndrome.value = "UTI / urinary tract";
    oeDiabetes.value = "Unknown";
    oeCdiff.value = "Unknown";
    oeFungal.value = "No";
    oeAllergy.value = "None / no known beta-lactam allergy";

    // Wire auto preview (left)
    [
      oeSetting, oeSyndrome, oeDiabetes, oeCrcl, oeCdiff, oeFungal,
      oeKnownPathogens, oeClues, oeAllergy, oeAllergyDetails
    ].forEach(el=>{
      el.addEventListener('input', updateOpenEvidencePreview);
      el.addEventListener('change', updateOpenEvidencePreview);
    });

    // Wire auto preview (right)
    [ cpFacility ].forEach(el=>{
      el.addEventListener('input', updateCopilotPreview);
      el.addEventListener('change', updateCopilotPreview);
    });

    // Buttons
    runOE.addEventListener('click', runOpenEvidence);
    runCP.addEventListener('click', runCopilot);
    clearOE.addEventListener('click', clearLeft);
    clearCP.addEventListener('click', clearRight);

    // First render previews
    updateOpenEvidencePreview();
    updateCopilotPreview();
  }

  init();
})();
</script>
</body>
</html>
