<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>UPMC Grand Rounds Copilot Payload Builder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --bg: #f3f4f6;
      --panel-bg: #ffffff;
      --accent: #2563eb;
      --accent-soft: #dbeafe;
      --accent-strong: #1d4ed8;
      --border: #d1d5db;
      --text: #111827;
      --text-soft: #6b7280;
      --radius-lg: 16px;
      --radius-md: 10px;
      --radius-sm: 6px;
      --shadow-soft: 0 10px 25px rgba(15, 23, 42, 0.12);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #e0f2fe 0, #f3f4f6 40%, #e5e7eb 100%);
      color: var(--text);
      min-height: 100vh;
      padding: 16px;
    }

    .page-wrap { max-width: 1200px; margin: 0 auto; }

    .header {
      background: linear-gradient(135deg, #ffffff, #e0f2fe);
      border-radius: 18px;
      padding: 16px 18px;
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.15);
      border: 1px solid rgba(148, 163, 184, 0.35);
      position: sticky;
      top: 8px;
      z-index: 10;
      backdrop-filter: blur(10px);
    }

    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .title {
      font-size: 1.25rem;
      font-weight: 800;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: var(--accent-strong);
    }

    .subtitle {
      font-size: 0.9rem;
      color: var(--text-soft);
      margin-top: 4px;
      line-height: 1.35;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(37, 99, 235, 0.06);
      color: var(--accent-strong);
      font-size: 0.78rem;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      border: 1px solid rgba(37, 99, 235, 0.18);
      white-space: nowrap;
    }

    .badge-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.28);
    }

    .layout {
      margin-top: 18px;
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1.2fr);
      gap: 16px;
    }

    @media (max-width: 980px) {
      .layout { grid-template-columns: minmax(0, 1fr); }
    }

    .panel {
      background: var(--panel-bg);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft);
      padding: 14px 14px 16px;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 8px;
      flex-wrap: wrap;
    }

    .panel-title {
      font-size: 0.98rem;
      font-weight: 900;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .step-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 26px;
      height: 26px;
      padding: 0 8px;
      border-radius: 999px;
      background: var(--accent);
      color: #ffffff;
      font-size: 0.85rem;
      font-weight: 900;
    }

    fieldset {
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      background: #f9fafb;
      padding: 10px;
      min-width: 0;
      margin-top: 10px;
    }

    legend {
      padding: 0 6px;
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-soft);
      font-weight: 900;
    }

    .hint {
      font-size: 0.78rem;
      color: var(--text-soft);
      margin-top: 6px;
      line-height: 1.35;
    }

    textarea, input[type="text"] {
      font-family: inherit;
      font-size: 0.92rem;
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: #ffffff;
      color: #111827;
      width: 100%;
      line-height: 1.45;
      margin-top: 6px;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }

    textarea { min-height: 110px; resize: vertical; }
    textarea:focus, input[type="text"]:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-soft);
    }

    .suggestions {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
      max-height: 170px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .suggest-chip {
      border: 1px solid var(--accent);
      background: #ffffff;
      color: var(--accent-strong);
      font-size: 0.8rem;
      padding: 6px 10px;
      border-radius: 999px;
      cursor: pointer;
      transition: all 0.15s ease;
      font-weight: 750;
      text-align: left;
    }
    .suggest-chip:hover {
      background: var(--accent);
      color: #ffffff;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.28);
    }

    .actions { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }

    .btn {
      flex: 1;
      min-width: 130px;
      padding: 9px 10px;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 0.82rem;
      font-weight: 900;
      cursor: pointer;
      transition: all 0.15s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .btn-primary { background: var(--accent); color: #ffffff; }
    .btn-primary:hover { background: var(--accent-strong); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(37,99,235,0.3); }

    .btn-secondary { background: #e5e7eb; color: var(--text); }
    .btn-secondary:hover { background: #d1d5db; transform: translateY(-1px); box-shadow: 0 3px 8px rgba(15,23,42,0.15); }

    .header-btn-small {
      padding: 7px 12px;
      border-radius: 999px;
      border: none;
      background: var(--accent);
      color: #ffffff;
      font-size: 0.82rem;
      font-weight: 900;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
      transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
      white-space: nowrap;
    }
    .header-btn-small:hover { background: var(--accent-strong); transform: translateY(-1px); box-shadow: 0 6px 16px rgba(37,99,235,0.4); }

    .header-btn-ghost {
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid rgba(37, 99, 235, 0.35);
      background: #ffffff;
      color: var(--accent-strong);
      font-size: 0.82rem;
      font-weight: 900;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      text-decoration: none;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      white-space: nowrap;
    }
    .header-btn-ghost:hover { transform: translateY(-1px); box-shadow: 0 6px 16px rgba(37,99,235,0.18); }

    .output-box {
      background: #0f172a;
      color: #e2e8f0;
      border-radius: var(--radius-md);
      padding: 10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-size: 0.82rem;
      line-height: 1.5;
      max-height: 580px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
      margin-top: 6px;
    }

    .small-meta {
      font-size: 0.75rem;
      color: var(--text-soft);
      margin-top: 8px;
      line-height: 1.35;
    }

    .session-list {
      display: grid;
      gap: 8px;
      margin-top: 10px;
      max-height: 240px;
      overflow: auto;
      padding-right: 4px;
    }

    .session-row {
      display: grid;
      grid-template-columns: 22px 1fr auto;
      gap: 10px;
      align-items: start;
      padding: 8px;
      background: #fff;
      border: 1px solid rgba(209, 213, 219, 0.9);
      border-radius: 12px;
    }

    .session-title {
      font-weight: 900;
      font-size: 0.88rem;
      line-height: 1.25;
    }

    .session-link {
      font-size: 0.78rem;
      color: var(--accent-strong);
      text-decoration: none;
      font-weight: 850;
      margin-top: 2px;
      display: inline-block;
    }
    .session-link:hover { text-decoration: underline; }

    .pill {
      border: 1px solid rgba(37, 99, 235, 0.35);
      background: rgba(37, 99, 235, 0.08);
      color: var(--accent-strong);
      border-radius: 999px;
      padding: 5px 10px;
      font-size: 0.74rem;
      font-weight: 900;
      white-space: nowrap;
      align-self: start;
    }
    .pill.backlog {
      border-color: rgba(245, 158, 11, 0.55);
      background: rgba(245, 158, 11, 0.10);
      color: #92400e;
    }

    .checkline {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      font-size: 0.86rem;
      line-height: 1.25;
      padding: 8px;
      border: 1px solid rgba(209, 213, 219, 0.9);
      border-radius: 12px;
      background: #fff;
      margin-top: 6px;
    }
    .checkline input { margin-top: 2px; }

    .toast {
      position: fixed;
      bottom: 18px;
      right: 18px;
      background: #111827;
      color: #ffffff;
      padding: 10px 16px;
      border-radius: var(--radius-sm);
      box-shadow: 0 10px 28px rgba(0, 0, 0, 0.4);
      font-size: 0.88rem;
      font-weight: 800;
      z-index: 1000;
      max-width: 90vw;
    }

    .debug-line {
      margin-top: 8px;
      font-size: 0.78rem;
      color: var(--text-soft);
      line-height: 1.35;
      word-break: break-word;
    }

    @keyframes pulse {
      0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.7); }
      70% { transform: scale(1.04); box-shadow: 0 0 0 10px rgba(37, 99, 235, 0); }
      100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(37, 99, 235, 0); }
    }
    .pulse { animation: pulse 0.9s ease; }
  </style>
</head>

<body>
<div class="page-wrap">
  <header class="header">
    <div class="header-top">
      <div>
        <div class="title" id="pageTitle">UPMC Grand Rounds ‚Äî Copilot Payload Builder</div>
        <div class="subtitle">
          Select sessions ‚Üí build payload ‚Üí open Copilot.
          <br><strong>Only for use with UPMC Microsoft 365 Copilot.</strong>
        </div>
        <div class="debug-line" id="loadInfo">Loading catalog‚Ä¶</div>
      </div>

      <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
        <span class="badge"><span class="badge-dot"></span> Prototype</span>
        <span class="badge" id="loadedBadge">0 loaded</span>
      </div>
    </div>
  </header>

  <div class="layout">
    <!-- LEFT -->
    <section class="panel">
      <div class="panel-header">
        <div class="panel-title"><span class="step-badge">1</span> Sessions + Options + Question</div>
      </div>

      <fieldset>
        <legend>Grand Rounds Sessions (checkable)</legend>
        <div class="hint">Default selection is the <strong>first 3</strong> sessions in the catalog.</div>
        <div class="actions">
          <button class="btn btn-secondary" id="selectAllBtn" type="button">‚úÖ Select all</button>
          <button class="btn btn-secondary" id="selectNoneBtn" type="button">üö´ Select none</button>
        </div>
        <div class="session-list" id="sessionList"></div>
      </fieldset>

      <fieldset>
        <legend>Question Options (defaults: first two checked)</legend>

        <label class="checkline">
          <input type="checkbox" id="optTakehomes" />
          <span><strong>Include 5 impactful take-homes</strong> ranked most important ‚Üí least.</span>
        </label>

        <label class="checkline">
          <input type="checkbox" id="optSpeakerEmail" />
          <span><strong>Surface speaker email</strong> (if present) and draft a short comment/thank-you note.</span>
        </label>

        <label class="checkline">
          <input type="checkbox" id="optRefs" />
          <span><strong>Extract referenced links/resources</strong> mentioned inside the session doc(s).</span>
        </label>

        <div class="hint">
          If you leave your question blank, the default output will:
          <strong>summarize + top take-homes for the first 3 selected sessions.</strong>
        </div>
      </fieldset>

      <fieldset>
        <legend>Your question</legend>
        <textarea id="question" placeholder="Leave blank for default summary + take-homes for first 3 selected sessions‚Ä¶"></textarea>
        <div class="hint">
          Tip: use the bubbles below for ‚ÄúWho gave a Grand Rounds on‚Ä¶‚Äù or ‚ÄúReferenced links/resources about‚Ä¶‚Äù
        </div>
      </fieldset>

      <fieldset>
        <legend>Example questions (from JSON)</legend>
        <div class="suggestions" id="suggestions"></div>
      </fieldset>

      <div class="actions">
        <button class="btn btn-primary" id="seeBtn" type="button">üëÅ See Prompt</button>
        <button class="btn btn-secondary" id="clearBtn" type="button">üßπ Clear</button>
      </div>
    </section>

    <!-- RIGHT -->
    <section class="panel">
      <div class="panel-header">
        <div class="panel-title"><span class="step-badge">2</span> Payload Preview</div>

        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <!-- Get 365 before Copilot -->
          <a class="header-btn-ghost" id="get365Btn" href="#" target="_blank" rel="noopener">‚úÖ Get 365</a>
          <button class="header-btn-small" id="copilotBtn" type="button">ü™ü Build & Open Copilot</button>
        </div>
      </div>

      <fieldset>
        <legend>Generated payload prompt</legend>
        <div class="output-box" id="output">
You haven't generated a payload yet.
Click "See Prompt" or "Build & Open Copilot" to construct it.
        </div>
      </fieldset>

      <div class="small-meta">
        After Copilot opens, click in the chat box and press
        <strong>Ctrl+V</strong> (Windows) or <strong>‚åò+V</strong> (Mac) to paste the payload.
      </div>
    </section>
  </div>
</div>

<script>
(function () {
  'use strict';

  // IMPORTANT: match your JSON filename in the same GitHub folder
  const DEFAULT_JSON_FILENAME = "grand_rounds_catalog.json";

  const pageTitle = document.getElementById('pageTitle');
  const loadedBadge = document.getElementById('loadedBadge');
  const loadInfo = document.getElementById('loadInfo');

  const sessionListEl = document.getElementById('sessionList');
  const suggestionsEl = document.getElementById('suggestions');

  const optTakehomes = document.getElementById('optTakehomes');
  const optSpeakerEmail = document.getElementById('optSpeakerEmail');
  const optRefs = document.getElementById('optRefs');

  const questionEl = document.getElementById('question');
  const outputEl = document.getElementById('output');

  const selectAllBtn = document.getElementById('selectAllBtn');
  const selectNoneBtn = document.getElementById('selectNoneBtn');

  const seeBtn = document.getElementById('seeBtn');
  const clearBtn = document.getElementById('clearBtn');

  const get365Btn = document.getElementById('get365Btn');
  const copilotBtn = document.getElementById('copilotBtn');

  let catalog = null;
  let sessions = [];
  let selectedIds = new Set();

  function toast(msg, ms) {
    ms = ms || 2600;
    const t = document.createElement('div');
    t.className = 'toast';
    t.textContent = msg;
    document.body.appendChild(t);
    setTimeout(() => t.remove(), ms);
  }

  function pulseCopilotButton() {
    copilotBtn.classList.remove('pulse');
    void copilotBtn.offsetWidth;
    copilotBtn.classList.add('pulse');
  }

  async function fetchJsonAbsolute(absoluteUrl) {
    const u = new URL(absoluteUrl);
    u.searchParams.set("_", String(Date.now())); // cache bust
    const res = await fetch(u.toString(), { cache: "no-store" });
    if (!res.ok) throw new Error("HTTP " + res.status + " for " + res.url);
    return await res.json();
  }

  function validateCatalog(obj) {
    if (!obj || typeof obj !== "object") throw new Error("Invalid JSON (not an object)");
    if (!obj.launcher || !obj.launcher.copilot_url || !obj.launcher.m365_signup_url) {
      throw new Error("JSON missing launcher.copilot_url or launcher.m365_signup_url");
    }
    if (!Array.isArray(obj.grand_rounds)) throw new Error("JSON grand_rounds must be an array");
    if (typeof obj.prompt_template !== "string") throw new Error("JSON missing prompt_template string");
    if (!Array.isArray(obj.suggestion_questions)) throw new Error("JSON suggestion_questions must be an array");
    return obj;
  }

  function fillTemplate(tpl, vars) {
    let out = tpl;
    Object.keys(vars).forEach(k => {
      out = out.split(`{{${k}}}`).join(String(vars[k]));
    });
    return out;
  }

  function normalizeSessions() {
    sessions = catalog.grand_rounds.map(gr => ({
      id: gr.id,
      name: gr.grand_rounds_name || "Untitled Grand Rounds",
      url: gr.public_sharepoint_url || "",
      status: (gr.status || "").toLowerCase()
    }));
  }

  function applyDefaults() {
    const defs = catalog.defaults || {};
    const defaultSelected = Array.isArray(defs.default_selected_ids) ? defs.default_selected_ids : [];

    // Default: first 3 sessions checked if not specified
    selectedIds = new Set();
    if (defaultSelected.length > 0) {
      defaultSelected.forEach(id => selectedIds.add(id));
    } else {
      for (let i = 0; i < Math.min(3, sessions.length); i++) {
        selectedIds.add(sessions[i].id);
      }
    }

    // Options: first two checked by default
    const opt = defs.options || {};
    optTakehomes.checked = (opt.include_takehomes !== false); // default true
    optSpeakerEmail.checked = (opt.include_speaker_email !== false); // default true
    optRefs.checked = (opt.include_referenced_links === true); // default false

    pulseCopilotButton();
  }

  function renderSessions() {
    sessionListEl.innerHTML = "";
    sessions.forEach(s => {
      const row = document.createElement("div");
      row.className = "session-row";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = selectedIds.has(s.id);
      cb.addEventListener("change", () => {
        if (cb.checked) selectedIds.add(s.id);
        else selectedIds.delete(s.id);
        pulseCopilotButton();
      });

      const mid = document.createElement("div");

      const title = document.createElement("div");
      title.className = "session-title";
      title.textContent = s.name;

      const link = document.createElement("a");
      link.className = "session-link";
      link.href = s.url || "#";
      link.target = "_blank";
      link.rel = "noopener";
      link.textContent = s.url ? "Open SharePoint link" : "(missing link)";

      mid.appendChild(title);
      mid.appendChild(link);

      const pill = document.createElement("div");
      pill.className = "pill" + (s.status === "backlog" ? " backlog" : "");
      pill.textContent = s.status === "backlog" ? "Backlog" : "GR";

      row.appendChild(cb);
      row.appendChild(mid);
      row.appendChild(pill);

      sessionListEl.appendChild(row);
    });

    loadedBadge.textContent = `${sessions.length} loaded`;
  }

  function renderSuggestions() {
    suggestionsEl.innerHTML = "";
    catalog.suggestion_questions.forEach(q => {
      const chip = document.createElement("button");
      chip.type = "button";
      chip.className = "suggest-chip";
      chip.textContent = q;
      chip.addEventListener("click", () => {
        questionEl.value = q;
        questionEl.focus();
        pulseCopilotButton();
      });
      suggestionsEl.appendChild(chip);
    });
  }

  function buildSourcesBlock(selected) {
    return selected.map(s => `- ${s.name}\n  ${s.url}`).join("\n");
  }

  function buildOptionsBlock() {
    const lines = [];
    if (optTakehomes.checked) lines.push("- Provide 5 impactful take-homes ranked most important ‚Üí least.");
    if (optSpeakerEmail.checked) lines.push("- If a speaker email is present, surface it and draft a short comment/thank-you note with one thoughtful question.");
    if (optRefs.checked) lines.push("- Extract referenced links/resources mentioned inside the document(s), and label each.");
    if (lines.length === 0) return "";
    return lines.join("\n") + "\n";
  }

  function getSelectedSessions() {
    return sessions.filter(s => selectedIds.has(s.id) && s.url);
  }

  function buildDefaultQuestionForFirst3Selected() {
    const selected = getSelectedSessions();

    // Use first 3 selected sessions (or fewer if user unchecks)
    const useThese = selected.slice(0, 3);
    const names = useThese.map(s => s.name).join("; ");

    let q = `Summarize the first ${useThese.length} selected Grand Rounds session(s) (${names}). For EACH session: extract presenter name + role/title, date/time, attendance code, and list ALL available links (video/transcript/take-home/mind map/other).`;

    if (optTakehomes.checked) q += " Provide 5 impactful take-homes per session ranked most important ‚Üí least.";
    if (optRefs.checked) q += " Also list any referenced links/resources mentioned inside the session document(s).";
    if (optSpeakerEmail.checked) q += " If the speaker email is present, surface it and draft a short comment/thank-you note.";

    return q;
  }

  function buildPrompt() {
    if (!catalog) {
      toast("Catalog not loaded yet.");
      return "";
    }

    const selected = getSelectedSessions();
    if (selected.length === 0) {
      toast("No sessions selected (or URLs missing). Check at least one session.");
      return "";
    }

    let userQ = (questionEl.value || "").trim();
    if (!userQ) {
      userQ = buildDefaultQuestionForFirst3Selected();
    }

    const prompt = fillTemplate(catalog.prompt_template, {
      COPILOT_URL: catalog.launcher.copilot_url,
      M365_SIGNUP_URL: catalog.launcher.m365_signup_url,
      SOURCES_BLOCK: buildSourcesBlock(selected),
      OPTIONS_BLOCK: buildOptionsBlock(),
      USER_QUESTION: userQ
    });

    outputEl.textContent = prompt;
    return prompt;
  }

  function clearAll() {
    questionEl.value = "";
    outputEl.textContent =
      "You haven't generated a payload yet.\nClick \"See Prompt\" or \"Build & Open Copilot\" to construct it.";
    pulseCopilotButton();
  }

  function copyToClipboard(text, cb) {
    if (!text) { toast("Nothing to copy."); return; }
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text).then(() => cb && cb(), () => {
        toast("Clipboard blocked. Select and copy manually.");
        cb && cb();
      });
    } else {
      toast("Clipboard not supported. Select and copy manually.");
      cb && cb();
    }
  }

  function openCopilot() {
    const prompt = buildPrompt();
    if (!prompt) return;

    copyToClipboard(prompt, () => {
      toast("Payload copied. Opening Copilot‚Ä¶", 2200);
      window.open(catalog.launcher.copilot_url, "_blank", "noopener");
    });
  }

  selectAllBtn.addEventListener("click", () => {
    selectedIds = new Set(sessions.map(s => s.id));
    renderSessions();
    pulseCopilotButton();
  });

  selectNoneBtn.addEventListener("click", () => {
    selectedIds = new Set();
    renderSessions();
    pulseCopilotButton();
  });

  seeBtn.addEventListener("click", () => {
    const p = buildPrompt();
    if (p) toast("Payload generated below.");
    pulseCopilotButton();
  });

  clearBtn.addEventListener("click", clearAll);
  copilotBtn.addEventListener("click", openCopilot);

  questionEl.addEventListener("input", pulseCopilotButton);
  optTakehomes.addEventListener("change", pulseCopilotButton);
  optSpeakerEmail.addEventListener("change", pulseCopilotButton);
  optRefs.addEventListener("change", pulseCopilotButton);

  async function loadCatalog() {
    // If you're opening locally (file://), fetch will usually fail.
    if (location.protocol === "file:") {
      loadInfo.textContent =
        "‚ö†Ô∏è You opened this as a local file (file://). JSON fetch will fail. Run via GitHub Pages or a local web server.";
      toast("Open via GitHub Pages (https://...) instead of file://");
      return;
    }

    const baseDir = new URL(".", location.href).toString();

    // Try multiple candidates so GitHub Pages ‚Äúsame folder‚Äù always works
    const candidates = [
      new URL(DEFAULT_JSON_FILENAME, baseDir).toString(),
      new URL("./" + DEFAULT_JSON_FILENAME, baseDir).toString(),
      new URL(DEFAULT_JSON_FILENAME, location.origin + new URL(".", location.pathname).toString()).toString()
    ];

    let lastErr = null;

    for (const u of candidates) {
      try {
        loadInfo.textContent = "Loading catalog from: " + u;
        const data = await fetchJsonAbsolute(u);
        catalog = validateCatalog(data);

        // Wire header/launcher
        if (catalog.catalog_name) pageTitle.textContent = catalog.catalog_name;
        get365Btn.href = catalog.launcher.m365_signup_url;

        normalizeSessions();
        applyDefaults();
        renderSessions();
        renderSuggestions();

        loadInfo.textContent = "‚úÖ Loaded catalog from: " + u;
        toast("Catalog loaded.");
        return;
      } catch (e) {
        lastErr = e;
      }
    }

    loadInfo.textContent =
      "‚ùå Failed to load JSON. Make sure '" + DEFAULT_JSON_FILENAME + "' is in the SAME GitHub folder as index.html, committed, and visible in the browser.";
    toast("JSON load failed. Open the JSON file directly in your browser to confirm it exists.", 4200);
    console.error(lastErr);
  }

  loadCatalog().catch(err => {
    console.error(err);
    toast("Unexpected error loading catalog.");
  });

})();
</script>
</body>
</html>
